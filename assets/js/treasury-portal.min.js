const EMBED_ORIGIN="https://realtreasury.com";let treasuryTechPortal,portalRoot;function postHeight(){if(window.parent!==window){const e=Math.max(document.documentElement.scrollHeight,document.documentElement.offsetHeight,document.body.scrollHeight,document.body.offsetHeight,window.innerHeight);window.parent.postMessage({type:"treasury-height",height:e+100},"*");try{window.parent.postMessage({type:"treasury-height",height:e+100},EMBED_ORIGIN)}catch(e){}}}function debounce(e,t){let o;return function(){clearTimeout(o),o=setTimeout(e,t)}}const debouncedPostHeight=debounce(postHeight,100);function containsRecordIds(e){return Array.isArray(e)?e.some(containsRecordIds):e&&"object"==typeof e?Object.values(e).some(containsRecordIds):"string"==typeof e&&/^rec[0-9a-z]/i.test(e)}window.addEventListener("load",()=>{setTimeout(postHeight,100),setTimeout(postHeight,500),setTimeout(postHeight,1e3)}),window.addEventListener("resize",debouncedPostHeight),document.addEventListener("DOMContentLoaded",async()=>{if(portalRoot=document.querySelector(".treasury-portal"),!portalRoot)return void console.warn("TreasuryTechPortal: .treasury-portal element not found. Aborting initialization.");new ResizeObserver(()=>{debouncedPostHeight()}).observe(portalRoot),new MutationObserver(()=>{debouncedPostHeight()}).observe(portalRoot,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]});const e=document.querySelector(".treasury-portal .container");if(!window.TTP_DATA){const t=document.createElement("div");return t.className="error-banner",t.textContent="Configuration data is unavailable.",t.style.cssText="padding:1rem;margin:1rem 0;background:#f8d7da;color:#721c24;border:1px solid #f5c2c7;border-radius:4px;",portalRoot.prepend(t),e&&e.classList.add("loaded"),void console.warn("TreasuryTechPortal: window.TTP_DATA is missing")}treasuryTechPortal=new TreasuryTechPortal,setTimeout(()=>{"function"==typeof postHeight&&postHeight()},1500),window.addEventListener("resize",()=>{window.innerWidth<=768?(treasuryTechPortal.sideMenuOpen&&treasuryTechPortal.closeSideMenu(),treasuryTechPortal.shortlistMenuOpen&&treasuryTechPortal.closeShortlistMenu()):treasuryTechPortal.renderShortlist(),setTimeout(()=>{"function"==typeof postHeight&&postHeight()},200)});const t=document.querySelectorAll(".rt-nav-item"),o=window.treasuryTechPortal;t.forEach(e=>{e.addEventListener("click",function(){o&&(o.sideMenuOpen&&o.closeSideMenu(),o.shortlistMenuOpen&&o.closeShortlistMenu())})}),document.addEventListener("click",function(e){(e.target.closest(".external-menu-toggle")||e.target.closest(".external-shortlist-toggle"))&&document.querySelectorAll(".rt-nav-item.active").forEach(e=>{e.classList.remove("active")})});const s=new URLSearchParams(window.location.search).get("tool");if(s&&document.cookie.includes("portal_access_token="))try{await treasuryTechPortal.toolsLoaded;const e=treasuryTechPortal.TREASURY_TOOLS.find(e=>e.name.toLowerCase()===decodeURIComponent(s).toLowerCase());e&&setTimeout(()=>treasuryTechPortal.showToolModal(e),500)}catch(e){console.error("Failed to load tools for deep link:",e)}});class TreasuryTechPortal{constructor(){this.TREASURY_TOOLS=[],this.toolsLoaded=this.fetchTools(),this.CATEGORY_INFO={CASH:{name:"Cash Tools",badge:"Essential",description:"Cash Tools are the essential first step for treasury teams moving away from manual spreadsheets. These platforms provide a single, unified view of bank balances and transactions through direct bank connections (via API or files). They excel at providing clear, real-time cash visibility and basic forecasting, allowing businesses to understand their current cash position and anticipate future needs without the complexity of a full TRMS.",features:["Bank Connectivity (API, SFTP)","Basic Forecasting Tools","Cash Visibility","Transaction Search, Sort, Tag, Group"],videoUrl:"https://realtreasury.com/wp-content/uploads/2025/08/Cash-Tools-Intro.mp4",videoPoster:"https://realtreasury.com/wp-content/uploads/2025/08/Cash-Tools-Intro.png"},LITE:{name:"Treasury Management System Lite (TMS-Lite)",badge:"Scalable",description:"TMS-Lite solutions bridge the gap between basic Cash Tools and enterprise TRMS platforms. They build upon cash visibility by adding crucial treasury functions like multi-currency cash positioning, initiating treasury payments (wires, transfers), and managing basic financial instruments like foreign exchange contracts. These systems are ideal for growing companies whose needs have outpaced simple cash tools but do not yet require the full complexity of an enterprise system.",features:["Bank Connectivity (API, SFTP)","Basic Forecasting Tools","Cash Visibility","Transaction Search, Sort, Tag, Group","Cash Positioning","Market Data","Treasury Payments (API, SFTP)"],videoUrl:"https://realtreasury.com/wp-content/uploads/2025/08/TMS-Lite-Intro.mp4",videoPoster:"https://realtreasury.com/wp-content/uploads/2025/08/TMS-Lite-Intro.png"},TRMS:{name:"Treasury & Risk Management Systems (TRMS)",badge:"Advanced",description:"Treasury & Risk Management Systems (TRMS) are comprehensive platforms for large, complex organizations. They offer a broad suite of tightly integrated modules far beyond cash visibility, covering debt and investment management, advanced financial risk analysis (FX, interest rates, commodities), hedge accounting, global payments, and in-house banking. These systems are designed to centralize and automate sophisticated treasury workflows.",features:["Bank Connectivity (API, SFTP)","Basic Forecasting Tools","Cash Visibility","Transaction Search, Sort, Tag, Group","Cash Positioning","Market Data","Treasury Payments (API, SFTP)","Derivatives (Interest, FX)","Intercompany Loans","Instrument Valuations","AI Forecasting","AI Insights","AP Payments","Bank Account Management","Basic FX (Spots, FWD)","Cash Accounting","Debt Management","Deal Accounting","In-House Banking","Investments","SWIFT Connectivity"],videoUrl:"https://realtreasury.com/wp-content/uploads/2025/08/TRMS-Intro.mp4",videoPoster:"https://realtreasury.com/wp-content/uploads/2025/08/TRMS-Intro.png"}};const e=["Bank Connectivity","Basic Forecasting Tools","Cash Visibility","Transaction Search, Sort, Tag, Group"],t=[...e,"Cash Positioning","Market Data","Treasury Payments"],o=[...t,"AI Forecasting","AI Insights","AP Payments","Bank Account Management","Basic FX (Spots, FWD)","Cash Accounting","Debt Management","Deal Accounting","In-House Banking","Investments","SWIFT Connectivity","Derivatives (Interest, FX)","Intercompany Loans","Instrument Valuations"];this.CATEGORY_TAGS={CASH:e,LITE:t,TRMS:o},this.availableCategories=Array.isArray(window.TTP_DATA&&TTP_DATA.available_categories)&&TTP_DATA.available_categories.length?TTP_DATA.available_categories:[],this.enabledCategories=Array.isArray(window.TTP_DATA&&TTP_DATA.enabled_categories)&&TTP_DATA.enabled_categories.length?TTP_DATA.enabled_categories:this.availableCategories,this.availableDomains=Array.isArray(window.TTP_DATA&&TTP_DATA.available_domains)&&TTP_DATA.available_domains.length?TTP_DATA.available_domains:[],this.enabledDomains=Array.isArray(window.TTP_DATA&&TTP_DATA.enabled_domains)&&TTP_DATA.enabled_domains.length?TTP_DATA.enabled_domains:this.availableDomains,this.categoryLabels=window.TTP_DATA&&TTP_DATA.category_labels||{},this.currentFilter="ALL",this.searchTerm="",this.filteredTools=[],this.allTags=[],this.allRegions=[],this.allCategories=[],this.allSubcategories=[],this.subcategoriesByCategory={},this.advancedFilters={features:[],hasVideo:!1,regions:[],categories:[],subcategories:[]},this.currentSort="name",this.currentView="grid",this.groupByCategory=!0,this.sideMenuOpen=!1,this.shortlist=[],this.shortlistMenuOpen=!1,this.touchDragTool=null,this.previousFocusedElement=null,this.videoTimes={},this.currentToolId=null,this.permanentToolPickerInitialized=!1,this.spaceHandler=null,this.handleOutsideSideMenuClick=e=>{const t=document.getElementById("sideMenu"),o=document.getElementById("sideMenuToggle"),s=document.getElementById("externalMenuToggle");!t||t.contains(e.target)||o?.contains(e.target)||s?.contains(e.target)||(e.stopPropagation(),this.closeSideMenu())},this.handleOutsideShortlistMenuClick=e=>{const t=document.getElementById("shortlistMenu"),o=document.getElementById("shortlistMenuToggle"),s=document.getElementById("externalShortlistToggle");!t||t.contains(e.target)||o?.contains(e.target)||s?.contains(e.target)||this.closeShortlistMenu()},this.init(),this.swipeStart=null,this.swipeThreshold=100,this.swipeVelocityThreshold=.3,window.addEventListener("message",e=>{if(e.origin.includes("youtube.com")&&"string"==typeof e.data)try{const t=JSON.parse(e.data);if("infoDelivery"===t.event&&"number"==typeof t.info&&t.id){const e=t.id.replace(/^yt-/,"");this.videoTimes[e]=t.info}}catch(e){}})}isMobile(){return window.matchMedia("(max-width: 768px)").matches}handleResponsive(){const e=this.isMobile();if(document.querySelectorAll(".tool-card").forEach(t=>{t.draggable=!e}),e){this.closeSideMenu(),this.closeShortlistMenu();const e=document.getElementById("externalMenuToggle"),t=document.getElementById("externalShortlistToggle");e&&(e.style.display="none"),t&&(t.style.display="none");const o=document.getElementById("bottomNav");o&&(o.style.display="flex")}else{const e=document.getElementById("externalMenuToggle"),t=document.getElementById("externalShortlistToggle");e&&(e.style.display="flex"),t&&(t.style.display="flex");const o=document.getElementById("bottomNav");o&&(o.style.display="none")}this.applyViewStyles()}normalizeCategory(e){const t=(e||"").toString().toUpperCase();for(const e in this.categoryLabels){if(!Object.prototype.hasOwnProperty.call(this.categoryLabels,e))continue;const o=(this.categoryLabels[e]||"").toString().toUpperCase();if(t.includes(e.toUpperCase())||o&&t.includes(o.toUpperCase()))return e}return t}async fetchTools(){const e=document.getElementById("loadingScreen"),t=document.querySelector(".treasury-portal .container"),o=document.getElementById("bottomNav");let s;e&&(e.classList.remove("fade-out"),e.style.display="none",s=setTimeout(()=>{e.style.display="block"},200));try{const e=new URL(TTP_DATA.rest_url),{regions:t=[],categories:o=[],subcategories:s=[]}=this.advancedFilters||{};t.forEach(t=>e.searchParams.append("region",t)),o.forEach(t=>e.searchParams.append("category",t)),s.forEach(t=>e.searchParams.append("sub_category",t));const n=await fetch(e.toString()),i=await n.json();let a=Array.isArray(i.vendors)?i.vendors:Array.isArray(i)?i:[];Array.isArray(i.enabled_domains)&&(this.enabledDomains=i.enabled_domains);const l=Array.isArray(this.enabledDomains)?this.enabledDomains:[];a=a.filter(e=>{const t=Array.isArray(e.domain)?e.domain:[];return 0===t.length||t.some(e=>l.includes(e))});const r=new Set,c=new Set,d=new Set,u={},h=(e,t)=>{const o="string"==typeof t?t.trim():"";o&&!/^\d+$/.test(o)&&e.add(o)};this.TREASURY_TOOLS=a.map(e=>{Array.isArray(e.regions)&&0!==e.regions.length||console.warn("Vendor missing regions:",e),e.category||Array.isArray(e.categories)&&0!==e.categories.length||console.warn("Vendor missing category:",e);let t="";Array.isArray(e.category)&&e.category.length>0?t=e.category[0]:e.category?t=e.category:Array.isArray(e.categories)&&e.categories.length>0?t=e.categories[0]:Array.isArray(e.category_names)&&e.category_names.length>0&&(t=e.category_names[0]);const o=this.normalizeCategory(t),s=Array.isArray(e.sub_categories)?e.sub_categories:[],n=Array.isArray(e.regions)?e.regions.map(e=>e.trim()):[];return h(c,t),u[o]||(u[o]=new Set),s.forEach(e=>{h(d,e),h(u[o],e)}),n.forEach(e=>h(r,e)),{name:e.name||"",desc:e.status||"",category:o,categoryName:t,subCategories:s,regions:n,videoUrl:e.video_url||"",websiteUrl:e.full_website_url||e.website||"",logoUrl:e.logo_url||"",capabilities:e.capabilities||[],target:""}}),this.allRegions=Array.from(r).sort((e,t)=>e.localeCompare(t)),this.allCategories=Array.from(c).sort((e,t)=>e.localeCompare(t)),this.allSubcategories=Array.from(d).sort((e,t)=>e.localeCompare(t)),this.subcategoriesByCategory={},Object.keys(u).forEach(e=>{this.subcategoriesByCategory[e]=Array.from(u[e]).sort((e,t)=>e.localeCompare(t))});const m=Array.from(new Set(this.TREASURY_TOOLS.map(e=>e.category)));this.enabledCategories=Array.from(new Set([...this.enabledCategories,...m])).sort((e,t)=>e.localeCompare(t)),this.updateCounts(),this.populateCategoryTags(),this.populateRegionFilters(),this.populateCategoryFilters(),this.populateSubcategoryFilters(),this.renderHeaderFilters(),this.renderSubcategoryTabs("ALL"===this.currentFilter?null:this.currentFilter),this.filterAndDisplayTools(),this.applyViewStyles()}catch(e){console.error("Failed to load tools:",e)}finally{t&&t.classList.add("loaded"),o&&(o.style.display="flex"),e&&(clearTimeout(s),"none"!==e.style.display&&(e.classList.add("fade-out"),e.addEventListener("transitionend",()=>{e.style.display="none"},{once:!0})))}}init(){this.setupInteractions(),this.setupSearch(),this.setupModals(),this.setupSideMenu(),this.setupShortlistMenu(),this.setupBottomNav(),this.handleResponsive(),window.addEventListener("resize",()=>this.handleResponsive())}handleTouchStart(e,t){this.isMobile()&&(this.swipeStart={x:e.touches[0].clientX,y:e.touches[0].clientY,time:Date.now(),element:t})}handleTouchMove(e,t){if(!this.swipeStart||!this.isMobile())return;const o=Math.abs(e.touches[0].clientX-this.swipeStart.x);o>Math.abs(e.touches[0].clientY-this.swipeStart.y)&&o>10&&e.preventDefault()}handleTouchEnd(e,t,o){if(!this.swipeStart||!this.isMobile())return;const s=e.changedTouches[0].clientX,n=e.changedTouches[0].clientY,i=s-this.swipeStart.x,a=n-this.swipeStart.y,l=Date.now()-this.swipeStart.time,r=Math.abs(i),c=Math.abs(a);if(Math.max(r,c)/l>this.swipeVelocityThreshold&&l<1e3){let e=!1;("sideMenu"===t&&i<-this.swipeThreshold||"shortlistMenu"===t&&i>this.swipeThreshold||("toolModal"===t||"categoryModal"===t)&&a>this.swipeThreshold)&&(e=!0),e&&o&&o()}this.swipeStart=null}setupSwipeToClose(e,t,o){const s=document.getElementById(e);if(!s)return;const n=e=>this.handleTouchStart(e,t),i=e=>this.handleTouchMove(e,t),a=e=>this.handleTouchEnd(e,t,o);s.addEventListener("touchstart",n,{passive:!1}),s.addEventListener("touchmove",i,{passive:!1}),s.addEventListener("touchend",a,{passive:!1}),s._swipeHandlers={touchstart:n,touchmove:i,touchend:a}}setupInteractions(){document.querySelectorAll(".category-header").forEach(e=>{e.addEventListener("click",t=>{if(t.target.closest(".show-more-category-tags-btn")||t.target.closest(".show-less-category-tags-btn"))return;const o=e.dataset.category;o&&this.CATEGORY_INFO[o]&&this.showCategoryModal(this.CATEGORY_INFO[o],o)})});const e=document.getElementById("mainContent");e&&e.addEventListener("click",e=>{if(e.target.classList.contains("show-more-capabilities-btn")){e.stopPropagation();const t=e.target.dataset.toolName,o=this.TREASURY_TOOLS.find(e=>e.name===t);if(o){const t=e.target.parentElement,s=[...o.capabilities].sort((e,t)=>e.localeCompare(t));t.innerHTML=s.map(e=>`<span class="tool-capability">${e}</span>`).join(""),t.innerHTML+=`<button class="show-less-capabilities-btn" data-tool-name="${o.name}">Show less</button>`}}else if(e.target.classList.contains("show-less-capabilities-btn")){e.stopPropagation();const t=e.target.dataset.toolName,o=this.TREASURY_TOOLS.find(e=>e.name===t);if(o){const t=e.target.parentElement,s=[...o.capabilities].sort((e,t)=>e.localeCompare(t)),n=s.slice(0,3),i=s.length>3;t.innerHTML=n.map(e=>`<span class="tool-capability">${e}</span>`).join(""),i&&(t.innerHTML+=`<button class="show-more-capabilities-btn" data-tool-name="${o.name}">... more</button>`)}}else if(e.target.classList.contains("show-more-category-tags-btn")){e.stopPropagation();const t=e.target.dataset.category,o=e.target.parentElement,s=[...this.CATEGORY_TAGS[t]||[]].sort((e,t)=>e.localeCompare(t));o.innerHTML=s.map(e=>`<span class="category-tag">${e}</span>`).join(""),o.innerHTML+=`<button class="show-less-category-tags-btn" data-category="${t}">Show less</button>`}else if(e.target.classList.contains("show-less-category-tags-btn")){e.stopPropagation();const t=e.target.dataset.category,o=e.target.parentElement,s=[...this.CATEGORY_TAGS[t]||[]].sort((e,t)=>e.localeCompare(t)),n=s.slice(0,3),i=s.length>3;o.innerHTML=n.map(e=>`<span class="category-tag">${e}</span>`).join(""),i&&(o.innerHTML+=`<button class="show-more-category-tags-btn" data-category="${t}">... more</button>`)}})}setupSearch(){const e=document.getElementById("searchInput"),t=document.getElementById("searchClear");e&&(e.addEventListener("input",e=>{this.searchTerm=e.target.value.toLowerCase(),t&&(t.style.display=this.searchTerm?"block":"none"),this.filterAndDisplayTools()}),e.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),this.closeSideMenu())})),t&&t.addEventListener("click",()=>{e&&(e.value="",e.focus()),this.searchTerm="",t.style.display="none",this.filterAndDisplayTools()})}setupTagSearch(){const e=document.getElementById("tagSearchInput"),t=document.getElementById("tagSearchClear");e&&e.addEventListener("input",()=>{const o=e.value.toLowerCase();t&&(t.style.display=o?"block":"none"),this.filterTagCheckboxes(o)}),t&&t.addEventListener("click",()=>{e&&(e.value="",e.focus()),t.style.display="none",this.filterTagCheckboxes("")})}filterTagCheckboxes(e){const t=document.getElementById("tagFilters");if(!t)return;t.querySelectorAll(".checkbox-item").forEach(t=>{const o=t.textContent.toLowerCase();t.style.display=o.includes(e)?"flex":"none"});const o=document.getElementById("showMoreTagFilters"),s=document.getElementById("showLessTagFilters"),n=document.getElementById("extraTagFilters");o&&s&&n&&(e?(n.style.display="block",o.style.display="none",s.style.display="none"):(n.style.display="none",s.style.display="none",o.style.display="inline-block"))}setupModals(){const e=document.getElementById("toolModal"),t=document.getElementById("modalClose");t&&t.addEventListener("click",()=>this.closeModal("toolModal")),e&&e.addEventListener("click",e=>{null===e.target.closest(".ttp-modal-content")&&this.closeModal("toolModal")});const o=document.getElementById("categoryModal"),s=document.getElementById("categoryModalClose");s&&s.addEventListener("click",()=>this.closeModal("categoryModal")),o&&o.addEventListener("click",e=>{null===e.target.closest(".ttp-modal-content")&&this.closeModal("categoryModal")});const n=document.querySelector(".treasury-portal"),i=n?.querySelector(".intro-video-target")||n,a=i?.getAttribute("data-video-src")||"",l=i?.getAttribute("data-poster")||"",r=(e,t)=>{const o=document.createElement("div");o.className="video-wrapper";const s=document.createElement("video");s.src=e,s.autoplay=!1,s.muted=!1,s.playsInline=!0,s.preload="metadata",s.setAttribute("playsinline",""),t&&(s.poster=t);const n=document.createElement("button");n.className="video-play-button",n.setAttribute("aria-label","Play video"),n.innerHTML="▶";const i=()=>{s.paused?s.play():s.pause()};return s.addEventListener("click",i),n.addEventListener("click",e=>{e.stopPropagation(),i()}),s.addEventListener("play",()=>o.classList.add("playing")),s.addEventListener("pause",()=>o.classList.remove("playing")),s.addEventListener("ended",()=>o.classList.remove("playing")),o.appendChild(s),o.appendChild(n),o},c=()=>{i.innerHTML='<div class="intro-video-fallback">Intro video unavailable</div>'};if(a){const e=r(a,l);e.querySelector("video").onerror=c,i.innerHTML="",i.appendChild(e)}else c();document.querySelectorAll(".category-video-target").forEach(e=>{const t=e.getAttribute("data-video-src"),o=e.getAttribute("data-poster");if(t){const s=r(t,o);e.innerHTML="",e.appendChild(s)}}),this.setupSwipeToClose("toolModal","toolModal",()=>this.closeModal("toolModal")),this.setupSwipeToClose("categoryModal","categoryModal",()=>this.closeModal("categoryModal")),document.addEventListener("keydown",e=>{"Escape"===e.key&&(this.closeModal("toolModal"),this.closeModal("categoryModal"))})}openModal(e){if(e){this.previousFocusedElement=document.activeElement,e.classList.add("show"),portalRoot.classList.add("modal-open");const t=e.querySelector('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])');if(t)t.focus();else{const t=e.querySelector(".ttp-modal-content");t&&t.focus()}}}showToolModal(e){const t=document.getElementById("toolModal"),o=document.getElementById("modalTitle"),s=document.getElementById("modalDescription"),n=document.getElementById("modalWebsiteLink"),i=t?.querySelector(".modal-body"),a=document.getElementById("modalToolLogo"),l=document.getElementById("modalCapabilities");if(!t||!i)return;if(this.spaceHandler&&(this.spaceHandler.el.removeEventListener("keydown",this.spaceHandler.fn),this.spaceHandler=null),this.currentToolId=e.name.toLowerCase().replace(/[^a-z0-9]+/g,"-"),o&&(o.textContent=e.name),s&&(s.textContent=e.desc),n&&(e.websiteUrl?(n.href=e.websiteUrl,n.style.display="inline-flex"):n.style.display="none"),a&&(e.logoUrl?e.websiteUrl?a.outerHTML=`<a href="${e.websiteUrl}" target="_blank" rel="noopener noreferrer" class="modal-logo-link">\n                                <img id="modalToolLogo" class="modal-tool-logo" src="${e.logoUrl}" alt="${e.name} logo">\n                            </a>`:(a.src=e.logoUrl,a.alt=`${e.name} logo`,a.style.display="block",a.parentElement.classList.contains("modal-logo-link")&&a.parentElement.replaceWith(a)):a.style.display="none",e.websiteUrl&&e.logoUrl&&setTimeout(()=>{const e=document.querySelector(".modal-logo-link");e&&e.addEventListener("click",e=>{e.stopPropagation()})},0)),l){const t=[...e.capabilities||[]].sort((e,t)=>e.localeCompare(t)),o=t.slice(0,5),s=t.length>5;l.innerHTML=o.map(e=>`<span class="tool-capability">${e}</span>`).join(""),s&&(l.innerHTML+=`<button class="show-more-modal-capabilities-btn" data-tool-name="${e.name}">... more (${t.length-5})</button>`),l.addEventListener("click",e=>{if(e.target.classList.contains("show-more-modal-capabilities-btn")){e.stopPropagation();const t=e.target.dataset.toolName,o=this.TREASURY_TOOLS.find(e=>e.name===t);if(o){const e=[...o.capabilities||[]].sort((e,t)=>e.localeCompare(t));l.innerHTML=e.map(e=>`<span class="tool-capability">${e}</span>`).join(""),l.innerHTML+=`<button class="show-less-modal-capabilities-btn" data-tool-name="${t}">Show less</button>`}}else if(e.target.classList.contains("show-less-modal-capabilities-btn")){e.stopPropagation();const t=e.target.dataset.toolName,o=this.TREASURY_TOOLS.find(e=>e.name===t);if(o){const e=[...o.capabilities||[]].sort((e,t)=>e.localeCompare(t)),s=e.slice(0,5),n=e.length>5;l.innerHTML=s.map(e=>`<span class="tool-capability">${e}</span>`).join(""),n&&(l.innerHTML+=`<button class="show-more-modal-capabilities-btn" data-tool-name="${t}">... more (${e.length-5})</button>`)}}})}const r=i.querySelector(".video-demo-section");if(r&&r.remove(),e.videoUrl){const t=document.createElement("div");t.className="feature-section video-demo-section";const o=this.videoTimes[this.currentToolId]||0;if(e.videoUrl.includes("youtu.be/")||e.videoUrl.includes("youtube.com/watch")){let s=e.videoUrl;if(e.videoUrl.includes("youtu.be/")){s=`https://www.youtube.com/embed/${e.videoUrl.split("youtu.be/")[1].split("?")[0]}`}else{s=`https://www.youtube.com/embed/${new URL(e.videoUrl).searchParams.get("v")}`}s+=(s.includes("?")?"&":"?")+"enablejsapi=1&playsinline=1",o&&(s+=`&start=${Math.floor(o)}&autoplay=1`),t.innerHTML=`\n                            <h4>🎥 Product Differentiator</h4>\n                            <div class="video-container">\n                                <iframe id="yt-${this.currentToolId}" src="${s}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy" playsinline></iframe>\n                            </div>\n                        `}else t.innerHTML=`\n                            <h4>🎥 Product Differentiator</h4>\n                            <div class="video-container">\n                                <video src="${e.videoUrl}" controls playsinline></video>\n                            </div>\n                        `,o&&(t.querySelector("video").currentTime=o);const s=l?.closest(".feature-section");s?i.insertBefore(t,s):i.appendChild(t)}this.openModal(t);const c=t.querySelector(".modal-content, .ttp-modal-content");if(c){const e=e=>{if("Space"===e.code||" "===e.key){const o=t.querySelector("video"),s=t.querySelector("iframe");o?(e.preventDefault(),o.paused?o.play():o.pause()):s&&s.contentWindow&&(e.preventDefault(),s.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}',"https://www.youtube.com"))}};c.addEventListener("keydown",e),this.spaceHandler={el:c,fn:e}}}showCategoryModal(e,t){const o=document.getElementById("categoryModal"),s=document.getElementById("categoryModalTitle"),n=document.getElementById("categoryModalDescription"),i=document.getElementById("categoryModalFeatures"),a=o?.querySelector(".modal-body");s&&(s.textContent=e.name),n&&(n.textContent=e.description),i&&(i.innerHTML="",e.features.forEach(e=>{const t=document.createElement("li");t.textContent=e,i.appendChild(t)}));const l=a?.querySelector(".video-demo-section");if(l&&l.remove(),e.videoUrl&&a){const t=document.createElement("div");t.className="feature-section video-demo-section";let o="";if(e.videoUrl.includes("youtu.be/")||e.videoUrl.includes("youtube.com/watch")){let t=e.videoUrl;if(e.videoUrl.includes("youtu.be/")){t=`https://www.youtube.com/embed/${e.videoUrl.split("youtu.be/")[1].split("?")[0]}`}else if(e.videoUrl.includes("youtube.com/watch")){t=`https://www.youtube.com/embed/${new URL(e.videoUrl).searchParams.get("v")}`}t+=(t.includes("?")?"&":"?")+"enablejsapi=1&playsinline=1",o=`<iframe src="${t}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy" playsinline></iframe>`}else{o=`<video controls preload="metadata"${e.videoPoster?` poster="${e.videoPoster}"`:""} playsinline>\n                                        <source src="${e.videoUrl}" type="video/mp4">\n                                        Your browser does not support the video tag.\n                                      </video>`}t.innerHTML=`\n                        <h4>🎥 Category Overview Video</h4>\n                        <div class="video-container">\n                             ${o}\n                        </div>\n                    `,a.insertBefore(t,a.firstChild)}this.openModal(o)}closeModal(e){const t=document.getElementById(e);if(t&&t.classList.contains("show")){if(t.classList.remove("show"),portalRoot.classList.remove("modal-open"),"toolModal"===e&&this.currentToolId){const e=this.currentToolId;t.querySelectorAll("iframe").forEach(t=>{t.src.includes("youtube.com")&&t.contentWindow&&(t.contentWindow.postMessage(JSON.stringify({event:"command",func:"getCurrentTime",id:`yt-${e}`}),"https://www.youtube.com"),t.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}',"https://www.youtube.com"))}),t.querySelectorAll("video").forEach(t=>{this.videoTimes[e]=t.currentTime,t.pause()}),this.spaceHandler&&(this.spaceHandler.el.removeEventListener("keydown",this.spaceHandler.fn),this.spaceHandler=null)}this.previousFocusedElement&&(this.previousFocusedElement.focus(),this.previousFocusedElement=null)}}filterAndDisplayTools(){let e=[...this.TREASURY_TOOLS];if(this.searchTerm){const t=this.searchTerm.toLowerCase();e=e.filter(e=>[e.name,e.desc,e.target,...e.capabilities||[]].join(" ").toLowerCase().includes(t))}else e="ALL"===this.currentFilter?e:e.filter(e=>e.category===this.currentFilter);const{regions:t,categories:o,subcategories:s}=this.advancedFilters;t.length&&(e=e.filter(e=>(e.regions||[]).some(e=>t.includes(e)))),o.length&&(e=e.filter(e=>o.includes(e.categoryName))),s.length&&(e=e.filter(e=>(e.subCategories||[]).some(e=>s.includes(e)))),this.advancedFilters.features.length&&(e=e.filter(e=>this.advancedFilters.features.every(t=>(e.capabilities||[]).includes(t)))),this.advancedFilters.hasVideo&&(e=e.filter(e=>e.videoUrl)),"name"===this.currentSort?e=e.sort((e,t)=>e.name.localeCompare(t.name)):"category"===this.currentSort&&(e=e.sort((e,t)=>e.category.localeCompare(t.category))),this.filteredTools=e,this.displayFilteredTools(),this.updateVisibleCounts()}displayFilteredTools(){const e=this.enabledCategories,t=this.filteredTools.length>0,o=document.getElementById("noResults");o&&(o.style.display=t?"none":"block");const s=document.getElementById("listViewContainer");if(!this.groupByCategory||this.searchTerm||this.advancedFilters.features.length||this.advancedFilters.hasVideo||this.advancedFilters.regions.length||this.advancedFilters.categories.length||this.advancedFilters.subcategories.length)return e.forEach(e=>{const t=document.querySelector(`.category-section[data-category="${e}"]`);t&&(t.style.display="none")}),void(s&&(s.innerHTML="",this.filteredTools.sort((e,t)=>e.name.localeCompare(t.name)).forEach(e=>{const t=this.createToolCard(e,e.category);s.appendChild(t)}),s.style.display=t?"grid":"none"));s&&(s.style.display="none"),e.forEach(e=>{const t=document.querySelector(`.category-section[data-category="${e}"]`),o=document.getElementById(`tools-${e}`),s=this.filteredTools.filter(t=>t.category===e).sort((e,t)=>e.name.localeCompare(t.name));o&&(o.innerHTML="");let n=!1;n=(this.searchTerm||"ALL"===this.currentFilter||this.currentFilter===e)&&s.length>0,t&&(t.style.display=n?"block":"none"),n&&o&&s.forEach(t=>{const s=this.createToolCard(t,e);o.appendChild(s)})})}createToolCard(e,t){const o=document.createElement("div");o.className=`tool-card tool-${t.toLowerCase()}`,o.draggable=!this.isMobile(),o.dataset.name=e.name;const s=containsRecordIds(e)||e.incomplete?'<span class="ttp-warning" title="Some data may be incomplete">⚠️</span>':"",n=[...e.capabilities||[]].sort((e,t)=>e.localeCompare(t)),i=n.slice(0,3),a=n.length>3;if(o.innerHTML=`\n                    <div class="tool-card-content">\n                        <div class="tool-header">\n                            <div class="tool-info">\n                                <div class="tool-name">\n                                    <div class="tool-name-group">\n                                        <span class="tool-name-title">${e.name}</span>${s}\n                                    </div>\n                                    ${e.logoUrl?`<a href="${e.websiteUrl||"#"}" target="_blank" rel="noopener noreferrer" class="tool-logo-link" ${e.websiteUrl?"":'style="pointer-events: none; cursor: default;"'}><img class="tool-logo-inline" src="${e.logoUrl}" alt="${e.name} logo"></a>`:""}\n                                </div>\n                                ${e.videoUrl?'<button type="button" class="video-indicator">▶ Demo</button>':""}\n                                <div class="tool-type">${this.categoryLabels[e.category]||e.category}</div>\n                            </div>\n                        </div>\n                        <div class="tool-description">${e.desc}</div>\n                    </div>\n                        <div class="tool-card-actions">\n                        <div class="tool-capabilities">\n                            ${i.map(e=>`<span class="tool-capability">${e}</span>`).join("")}\n                            ${a?`<button class="show-more-capabilities-btn" data-tool-name="${e.name}">... more</button>`:""}\n                        </div>\n                    </div>\n                `,o.addEventListener("click",t=>{t.target.closest(".show-more-capabilities-btn")||t.target.closest(".show-less-capabilities-btn")||this.showToolModal(e)}),this.isMobile()||(o.addEventListener("dragstart",t=>{t.dataTransfer.setData("text/plain",e.name),this.openShortlistMenu("dragstart")}),o.addEventListener("touchstart",()=>{this.touchDragTool=e,this.openShortlistMenu()}),o.addEventListener("touchmove",e=>{const t=document.getElementById("shortlistContainer");if(!t)return;const o=e.touches[0],s=document.elementFromPoint(o.clientX,o.clientY);s&&t.contains(s)?t.classList.add("drag-over"):t.classList.remove("drag-over"),e.preventDefault()},{passive:!1}),o.addEventListener("touchend",e=>{const t=document.getElementById("shortlistContainer");if(t&&t.classList.remove("drag-over"),this.touchDragTool&&t){const o=e.changedTouches[0],s=document.elementFromPoint(o.clientX,o.clientY);s&&t.contains(s)&&!this.shortlist.some(e=>e.tool.name===this.touchDragTool.name)&&(this.shortlist.push({tool:this.touchDragTool,notes:""}),this.renderShortlist())}this.touchDragTool=null})),e.websiteUrl){const e=o.querySelector(".tool-logo-link");e&&e.addEventListener("click",e=>{e.stopPropagation()})}return o}populateCategoryTags(){this.enabledCategories.forEach(e=>{const t=document.getElementById(`category-tags-${e}`);if(t){const o=[...this.CATEGORY_TAGS[e]||[]].sort((e,t)=>e.localeCompare(t)),s=o.slice(0,3),n=o.length>3;t.innerHTML=s.map(e=>`<span class="category-tag">${e}</span>`).join(""),n&&(t.innerHTML+=`<button class="show-more-category-tags-btn" data-category="${e}">... more</button>`)}})}populateTagFilters(){const e=document.getElementById("tagFilters");if(!e)return;const t=[...new Set(Object.values(this.CATEGORY_TAGS).flat())].sort((e,t)=>e.localeCompare(t));this.allTags=t;const o=t.slice(0,4),s=t.slice(4),n=e=>{const t=`tag-${e.replace(/[^a-z0-9]+/gi,"-").toLowerCase()}`;return`<div class="checkbox-item"><input type="checkbox" id="${t}" value="${e}"><label for="${t}">${e}</label></div>`};e.innerHTML=o.map(n).join(""),s.length&&(e.innerHTML+=`<div id="extraTagFilters" style="display:none;">${s.map(n).join("")}</div>`,e.innerHTML+='<button class="show-more-filter-tags-btn" id="showMoreTagFilters">Show more</button>',e.innerHTML+='<button class="show-less-filter-tags-btn" id="showLessTagFilters" style="display:none;">Show less</button>')}populateRegionFilters(){const e=document.getElementById("regionFilters");if(!e)return;e.innerHTML=this.allRegions.map(e=>{const t=`region-${e.replace(/[^a-z0-9]+/gi,"-").toLowerCase()}`;return`<div class="checkbox-item"><input type="checkbox" id="${t}" value="${e}"><label for="${t}">${e}</label></div>`}).join("");const t=e.querySelectorAll('input[type="checkbox"]');t.forEach(e=>{e.addEventListener("change",()=>{this.advancedFilters.regions=Array.from(t).filter(e=>e.checked).map(e=>e.value),this.filterAndDisplayTools(),this.updateFilterCount()})})}populateCategoryFilters(){const e=document.getElementById("categoryFilters");if(!e)return;e.innerHTML="";this.allCategories.forEach(t=>e.appendChild((e=>{const t=`cat-${e.replace(/[^a-z0-9]+/gi,"-").toLowerCase()}`,o=document.createElement("div");o.className="checkbox-item";const s=document.createElement("input");s.type="checkbox",s.id=t,s.value=e;const n=document.createElement("label");return n.setAttribute("for",t),n.textContent=e,o.appendChild(s),o.appendChild(n),o})(t)));const t=e.querySelectorAll('input[type="checkbox"]');t.forEach(e=>{e.addEventListener("change",()=>{this.advancedFilters.categories=Array.from(t).filter(e=>e.checked).map(e=>e.value),this.currentFilter=1===this.advancedFilters.categories.length?this.normalizeCategory(this.advancedFilters.categories[0]):"ALL",this.renderSubcategoryTabs("ALL"===this.currentFilter?null:this.currentFilter),this.filterAndDisplayTools(),this.updateFilterCount()})})}populateSubcategoryFilters(){const e=document.getElementById("subcategoryFilters");if(!e)return;e.innerHTML="";this.allSubcategories.forEach(t=>e.appendChild((e=>{const t=`sub-${e.replace(/[^a-z0-9]+/gi,"-").toLowerCase()}`,o=document.createElement("div");o.className="checkbox-item";const s=document.createElement("input");s.type="checkbox",s.id=t,s.value=e;const n=document.createElement("label");return n.setAttribute("for",t),n.textContent=e,o.appendChild(s),o.appendChild(n),o})(t)));const t=e.querySelectorAll('input[type="checkbox"]');t.forEach(e=>{e.addEventListener("change",()=>{this.advancedFilters.subcategories=Array.from(t).filter(e=>e.checked).map(e=>e.value),this.filterAndDisplayTools(),this.updateFilterCount()})})}renderSubcategoryTabs(e){const t=document.querySelector(".filter-tabs");if(!t)return;t.innerHTML="",t.style.display="none",this.advancedFilters.subcategories=[];if(document.querySelectorAll('#subcategoryFilters input[type="checkbox"]').forEach(e=>e.checked=!1),!e||!this.subcategoriesByCategory[e])return;const o=this.subcategoriesByCategory[e];if(!o.length)return;t.style.display="flex";const s=(e,t="")=>{const o=document.createElement("button");return o.className="filter-tab",o.type="button",o.textContent=e,o.dataset.subcategory=t,o},n=s("All");n.classList.add("active"),t.appendChild(n),o.forEach(e=>t.appendChild(s(e,e))),t.querySelectorAll(".filter-tab").forEach(e=>{e.addEventListener("click",e=>{t.querySelector(".filter-tab.active")?.classList.remove("active"),e.target.classList.add("active");const o=e.target.dataset.subcategory;this.advancedFilters.subcategories=o?[o]:[],this.filterAndDisplayTools(),this.updateFilterCount()})})}renderHeaderFilters(){const e=document.getElementById("headerFilters");if(!e)return;e.innerHTML="";const t=document.createElement("select");t.id="headerRegionFilter",t.className="header-filter";const o=document.createElement("option");o.value="",o.textContent="All Regions",t.appendChild(o),this.allRegions.forEach(e=>{const o=document.createElement("option");o.value=e,o.textContent=e,t.appendChild(o)});const s=document.createElement("select");s.id="headerCategoryFilter",s.className="header-filter";const n=document.createElement("option");n.value="",n.textContent="All Categories",s.appendChild(n),this.allCategories.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,s.appendChild(t)}),e.appendChild(t),e.appendChild(s),t.addEventListener("change",e=>{const t=e.target.value;this.advancedFilters.regions=t?[t]:[],this.filterAndDisplayTools(),this.updateFilterCount()}),s.addEventListener("change",e=>{const t=e.target.value;this.advancedFilters.categories=t?[t]:[],this.currentFilter=1===this.advancedFilters.categories.length?this.normalizeCategory(this.advancedFilters.categories[0]):"ALL",this.renderSubcategoryTabs("ALL"===this.currentFilter?null:this.currentFilter),this.filterAndDisplayTools(),this.updateFilterCount()})}updateVisibleCounts(){const e=this.enabledCategories.map(e=>{const t=this.filteredTools.filter(t=>t.category===e).length,o=document.getElementById(`count-${e}`);return o&&(o.textContent=t),t}),t=this.filteredTools.length,o=this.searchTerm||this.advancedFilters.features.length||this.advancedFilters.hasVideo||this.advancedFilters.regions.length||this.advancedFilters.categories.length||this.advancedFilters.subcategories.length,s=document.getElementById("totalTools");s&&(s.textContent=o?t:this.TREASURY_TOOLS.length);const n=document.getElementById("totalCategories");if(n)if(o){const e=new Set(this.filteredTools.map(e=>e.categoryName).filter(Boolean));n.textContent=e.size}else n.textContent=this.allCategories.length;const i=e.reduce((e,t)=>e+t,0);o&&i!==t&&console.warn(`Category counts (${i}) do not sum to visible total (${t})`)}updateCounts(){this.enabledCategories.forEach(e=>{const t=this.TREASURY_TOOLS.filter(t=>t.category===e).length,o=document.getElementById(`count-${e}`);o&&(o.textContent=t)});const e=document.getElementById("totalTools");e&&(e.textContent=this.TREASURY_TOOLS.length);const t=document.getElementById("totalCategories");t&&(t.textContent=this.allCategories.length)}setupSideMenu(){const e=document.getElementById("sideMenuToggle"),t=document.getElementById("externalMenuToggle"),o=document.getElementById("sideMenu"),s=document.getElementById("sideMenuOverlay");e&&e.addEventListener("click",()=>this.toggleSideMenu()),t&&t.addEventListener("click",()=>this.toggleSideMenu()),s&&s.addEventListener("click",()=>this.closeSideMenu()),o&&o.addEventListener("click",e=>{this.isMobile()||this.sideMenuOpen||e.target!==o||(e.stopPropagation(),this.openSideMenu())}),this.setupSwipeToClose("sideMenu","sideMenu",()=>this.closeSideMenu()),this.setupAdvancedFilters(),this.setupViewOptions(),this.setupQuickActions(),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.sideMenuOpen&&this.closeSideMenu()})}setupAdvancedFilters(){this.populateTagFilters(),this.setupTagSearch();const e=document.getElementById("showMoreTagFilters"),t=document.getElementById("showLessTagFilters"),o=document.getElementById("extraTagFilters");e&&t&&o&&(e.addEventListener("click",()=>{o.style.display="block",e.style.display="none",t.style.display="inline-block"}),t.addEventListener("click",()=>{o.style.display="none",t.style.display="none",e.style.display="inline-block"}));document.querySelectorAll('#tagFilters input[type="checkbox"]').forEach(e=>{e.addEventListener("change",()=>{this.updateFeatureFilters(),this.filterAndDisplayTools(),this.updateFilterCount()})});const s=document.getElementById("hasVideoFilter");s&&s.addEventListener("change",e=>{this.advancedFilters.hasVideo=e.target.checked,this.filterAndDisplayTools(),this.updateFilterCount()});const n=document.getElementById("sortFilter");n&&n.addEventListener("change",e=>{this.currentSort=e.target.value,this.filterAndDisplayTools()})}setupViewOptions(){const e=document.querySelectorAll(".view-option");e.forEach(t=>{t.addEventListener("click",()=>{e.forEach(e=>e.classList.remove("active")),t.classList.add("active"),this.currentView=t.dataset.view,this.applyViewStyles()})});const t=document.getElementById("groupByFilter");t&&t.addEventListener("change",e=>{this.groupByCategory="category"===e.target.value,this.filterAndDisplayTools()})}setupQuickActions(){const e=document.getElementById("clearAllFilters");e&&e.addEventListener("click",()=>this.clearAllFilters());const t=document.getElementById("resetToDefaults");t&&t.addEventListener("click",()=>this.resetToDefaults());const o=document.getElementById("applyFilters");o&&o.addEventListener("click",()=>{this.filterAndDisplayTools(),this.closeSideMenu()})}toggleSideMenu(){this.sideMenuOpen?this.closeSideMenu():this.openSideMenu()}openSideMenu(){this.closeShortlistMenu();const e=document.getElementById("sideMenu"),t=document.getElementById("sideMenuOverlay"),o=document.getElementById("sideMenuToggle"),s=document.getElementById("externalMenuToggle");e?.classList.add("open"),portalRoot.classList.add("side-menu-open"),t?.classList.add("show"),o?.classList.add("active"),s&&(s.classList.add("active"),s.style.display="none"),this.isMobile()?(document.body.style.overflow="hidden",document.body.style.position="fixed",document.body.style.width="100%"):portalRoot.style.overflow="hidden",document.addEventListener("click",this.handleOutsideSideMenuClick,!0),this.sideMenuOpen=!0}closeSideMenu(){const e=document.getElementById("sideMenu"),t=document.getElementById("sideMenuOverlay"),o=document.getElementById("sideMenuToggle"),s=document.getElementById("externalMenuToggle");e?.classList.remove("open"),t?.classList.remove("show"),o?.classList.remove("active"),s&&(s.classList.remove("active"),s.style.display=this.isMobile()?"none":"flex"),portalRoot.classList.remove("side-menu-open"),this.isMobile()?(document.body.style.overflow="",document.body.style.position="",document.body.style.width=""):portalRoot.style.overflow="",document.removeEventListener("click",this.handleOutsideSideMenuClick,!0),this.sideMenuOpen=!1}setupShortlistMenu(){const e=document.getElementById("shortlistMenuToggle"),t=document.getElementById("shortlistMenuOverlay"),o=document.getElementById("externalShortlistToggle"),s=document.getElementById("shortlistContainer"),n=document.getElementById("clearShortlist"),i=document.getElementById("exportShortlistBtn");e&&e.addEventListener("click",()=>this.toggleShortlistMenu()),o&&o.addEventListener("click",()=>this.toggleShortlistMenu()),t&&(t.addEventListener("dragover",e=>e.preventDefault()),t.addEventListener("drop",e=>e.preventDefault())),this.setupSwipeToClose("shortlistMenu","shortlistMenu",()=>this.closeShortlistMenu());const a=document.getElementById("shortlistMenu");if(a&&a.addEventListener("click",e=>{this.isMobile()||this.shortlistMenuOpen||e.target!==a||(e.stopPropagation(),this.openShortlistMenu())}),n&&n.addEventListener("click",()=>this.clearShortlist()),i&&i.addEventListener("click",()=>this.exportShortlist()),s){let e=null,t=null,o=null,n=null;const i=()=>s.classList.add("drag-over"),a=()=>s.classList.remove("drag-over");s.addEventListener("dragstart",t=>{t.target.classList.contains("shortlist-card")?(e=t.target,t.dataTransfer.setData("text/plain",t.target.dataset.name),t.dataTransfer.effectAllowed="move",t.dataTransfer.setDragImage(new Image,0,0),o=t.target.cloneNode(!0),o.classList.add("drag-preview"),o.style.width=`${t.target.offsetWidth}px`,o.style.height=`${t.target.offsetHeight}px`,portalRoot.appendChild(o),n=e=>{o.style.left=`${e.clientX}px`,o.style.top=`${e.clientY}px`},window.addEventListener("pointermove",n),n(t)):e=null}),s.addEventListener("dragenter",i),s.addEventListener("dragleave",e=>{e.target===s&&a()}),s.addEventListener("dragover",t=>{if(t.preventDefault(),e){const o=t.target.closest(".shortlist-card");if(o&&o!==e){const n=o.getBoundingClientRect(),i=t.clientY-n.top>n.height/2;s.insertBefore(e,i?o.nextSibling:o)}}}),s.addEventListener("drop",t=>{if(t.preventDefault(),a(),e)this.shortlist=Array.from(s.querySelectorAll(".shortlist-card")).map(e=>{const t=e.dataset.name;return this.shortlist.find(e=>e.tool.name===t)}),e=null,this.renderShortlist();else{const e=t.dataTransfer.getData("text/plain"),o=this.TREASURY_TOOLS.find(t=>t.name===e);o&&!this.shortlist.some(t=>t.tool.name===e)&&(this.shortlist.push({tool:o,notes:""}),this.renderShortlist())}}),s.addEventListener("dragend",()=>{window.removeEventListener("pointermove",n),o&&(o.remove(),o=null)}),s.addEventListener("touchstart",e=>{const s=e.target.closest(".shortlist-card");if(s){t=s,i(),o=s.cloneNode(!0),o.classList.add("drag-preview"),o.style.width=`${s.offsetWidth}px`,o.style.height=`${s.offsetHeight}px`,portalRoot.appendChild(o);const n=e.touches[0];o.style.left=`${n.clientX}px`,o.style.top=`${n.clientY}px`}},{passive:!0}),s.addEventListener("touchmove",e=>{if(!t)return;const n=e.touches[0];o&&(o.style.left=`${n.clientX}px`,o.style.top=`${n.clientY}px`);const i=document.elementFromPoint(n.clientX,n.clientY)?.closest(".shortlist-card");if(i&&i!==t){const e=i.getBoundingClientRect(),o=n.clientY-e.top>e.height/2;s.insertBefore(t,o?i.nextSibling:i)}e.preventDefault()},{passive:!1}),s.addEventListener("touchend",()=>{t&&(a(),this.shortlist=Array.from(s.querySelectorAll(".shortlist-card")).map(e=>{const t=e.dataset.name;return this.shortlist.find(e=>e.tool.name===t)}),t=null,o&&(o.remove(),o=null),this.renderShortlist())})}document.addEventListener("keydown",e=>{"Escape"===e.key&&this.shortlistMenuOpen&&this.closeShortlistMenu()}),this.renderShortlist(),this.setupPermanentToolPicker()}toggleShortlistMenu(){this.shortlistMenuOpen?this.closeShortlistMenu():this.openShortlistMenu()}openShortlistMenu(e){this.closeSideMenu();const t=document.getElementById("shortlistMenu"),o=document.getElementById("shortlistMenuOverlay"),s=document.getElementById("shortlistMenuToggle"),n=document.getElementById("externalShortlistToggle");t?.classList.add("open"),portalRoot.classList.add("shortlist-menu-open"),o?.classList.add("show"),document.addEventListener("click",this.handleOutsideShortlistMenuClick),s?.classList.add("active"),n?.classList.add("active"),this.isMobile()?(document.body.style.overflow="hidden",document.body.style.position="fixed",document.body.style.width="100%"):portalRoot.style.overflow="hidden",this.shortlistMenuOpen=!0,this.permanentToolPickerInitialized&&this.updatePermanentToolPicker()}closeShortlistMenu(){const e=document.getElementById("shortlistMenu"),t=document.getElementById("shortlistMenuOverlay"),o=document.getElementById("shortlistMenuToggle"),s=document.getElementById("externalShortlistToggle");e?.classList.remove("open"),portalRoot.classList.remove("shortlist-menu-open"),t?.classList.remove("show"),document.removeEventListener("click",this.handleOutsideShortlistMenuClick),o?.classList.remove("active"),s?.classList.remove("active"),this.isMobile()?(document.body.style.overflow="",document.body.style.position="",document.body.style.width=""):portalRoot.style.overflow="",this.shortlistMenuOpen=!1}renderShortlist(){const e=document.getElementById("shortlistContainer"),t=document.getElementById("shortlistEmptyMessage");if(!e)return;e.innerHTML="",t&&e.appendChild(t),0===this.shortlist.length?(e.classList.add("empty"),t&&t.classList.remove("visually-hidden")):(e.classList.remove("empty"),t&&t.classList.add("visually-hidden"),this.shortlist.forEach(t=>{const o=document.createElement("div");o.className="shortlist-card",o.draggable=!0,o.dataset.name=t.tool.name,o.innerHTML=`\n                            <div class="shortlist-card-header">\n                                <div class="shortlist-card-title-wrapper">\n                                    ${t.tool.logoUrl?`<img class="shortlist-logo" src="${t.tool.logoUrl}" alt="${t.tool.name} logo">`:""}\n                                    <span class="shortlist-card-title">${t.tool.name}</span>\n                                    ${t.tool.websiteUrl?`<a class="shortlist-card-link" href="${t.tool.websiteUrl}" target="_blank" rel="noopener noreferrer" aria-label="Visit website">Visit Website</a>`:""}\n                                </div>\n                                <div class="shortlist-card-buttons">\n                                    <button class="move-up" data-name="${t.tool.name}" aria-label="Move up">▲</button>\n                                    <button class="move-down" data-name="${t.tool.name}" aria-label="Move down">▼</button>\n                                    <button class="remove-shortlist" data-name="${t.tool.name}" aria-label="Remove">×</button>\n                                </div>\n                            </div>\n                            <textarea class="shortlist-note" data-name="${t.tool.name}" placeholder="Notes...">${t.notes||""}</textarea>`,e.appendChild(o)})),e.querySelectorAll(".remove-shortlist").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.dataset.name;this.shortlist=this.shortlist.filter(e=>e.tool.name!==t),this.renderShortlist()})}),e.querySelectorAll(".move-up").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.dataset.name,o=this.shortlist.findIndex(e=>e.tool.name===t);if(o>0){const[e]=this.shortlist.splice(o,1);this.shortlist.splice(o-1,0,e),this.renderShortlist()}})}),e.querySelectorAll(".move-down").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.dataset.name,o=this.shortlist.findIndex(e=>e.tool.name===t);if(o<this.shortlist.length-1&&-1!==o){const[e]=this.shortlist.splice(o,1);this.shortlist.splice(o+1,0,e),this.renderShortlist()}})}),e.querySelectorAll(".shortlist-note").forEach(e=>{e.addEventListener("input",e=>{const t=e.target.dataset.name,o=this.shortlist.find(e=>e.tool.name===t);o&&(o.notes=e.target.value)})});const o=document.getElementById("exportShortlistBtn");o&&(o.disabled=0===this.shortlist.length),this.updatePermanentToolPicker()}updatePermanentToolPicker(){const e=document.getElementById("permanentToolPicker")?.querySelector(".tool-picker-button"),t=document.getElementById("permanentDropdown"),o=document.getElementById("permanentSearch"),s=document.getElementById("permanentList");if(!(e&&t&&o&&s))return;const n=this.TREASURY_TOOLS.filter(e=>!this.shortlist.some(t=>t.tool.name===e.name));s.innerHTML=n.map(e=>`<li data-name="${e.name}">${e.name}</li>`).join(""),e.textContent=n.length>0?`Add a Tool (${n.length} available)`:"All tools added",e.disabled=0===n.length,o.value="",t.style.display="none"}setupPermanentToolPicker(){const e=document.getElementById("permanentToolPicker")?.querySelector(".tool-picker-button"),t=document.getElementById("permanentDropdown"),o=document.getElementById("permanentSearch"),s=document.getElementById("permanentList");e&&t&&o&&s&&(e.addEventListener("click",e=>{e.stopPropagation();const s="block"===t.style.display;t.style.display=s?"none":"block",s||o.focus()}),o.addEventListener("input",()=>{const e=o.value.toLowerCase();s.querySelectorAll("li").forEach(t=>{const o=t.textContent.toLowerCase().includes(e);t.style.display=o?"block":"none"})}),s.addEventListener("click",e=>{if("LI"===e.target.tagName){const o=e.target.dataset.name,s=this.TREASURY_TOOLS.find(e=>e.name===o);s&&!this.shortlist.some(e=>e.tool.name===o)&&(this.shortlist.push({tool:s,notes:""}),this.renderShortlist()),t.style.display="none"}}),document.addEventListener("click",e=>{const o=document.getElementById("permanentToolPicker");o&&!o.contains(e.target)&&(t.style.display="none")}),this.updatePermanentToolPicker(),this.permanentToolPickerInitialized=!0)}clearShortlist(){this.shortlist=[],this.renderShortlist()}setupBottomNav(){const e=document.getElementById("bottomSearch"),t=document.getElementById("bottomShortlist");if(e){const t=e=>{e.preventDefault(),e.stopPropagation(),this.shortlistMenuOpen&&this.closeShortlistMenu(),this.sideMenuOpen?this.closeSideMenu():(this.openSideMenu(),setTimeout(()=>{const e=document.getElementById("searchInput");e&&(e.focus(),/iPad|iPhone|iPod/.test(navigator.userAgent)&&e.click())},350))};e.addEventListener("touchstart",e=>e.preventDefault()),e.addEventListener("click",t),e.addEventListener("touchend",e=>{e.preventDefault(),t(e)})}if(t){const e=e=>{e.preventDefault(),e.stopPropagation(),this.sideMenuOpen&&this.closeSideMenu(),this.toggleShortlistMenu()};t.addEventListener("click",e),t.addEventListener("touchend",t=>{t.preventDefault(),e(t)})}}updateFeatureFilters(){const e=document.querySelectorAll('#tagFilters input[type="checkbox"]');this.advancedFilters.features=Array.from(e).filter(e=>e.checked).map(e=>e.value)}applyViewStyles(){document.querySelectorAll(".tools-grid").forEach(e=>{e.classList.remove("list-view"),"list"===this.currentView?(e.classList.add("list-view"),e.style.gridTemplateColumns="1fr"):this.isMobile()?e.style.gridTemplateColumns="1fr":e.style.gridTemplateColumns="repeat(auto-fill, minmax(320px, 1fr))"})}exportShortlist(){const e=this.shortlist.map(e=>({name:e.tool.name,category:e.tool.category,website:e.tool.websiteUrl||"",notes:e.notes||""})),t=this.convertToCSV(e);this.downloadCSV(t,"shortlist.csv")}convertToCSV(e){if(!e.length)return"";const t=Object.keys(e[0]);return[t.join(","),...e.map(e=>t.map(t=>`"${String(e[t]).replace(/"/g,'""')}"`).join(","))].join("\n")}downloadCSV(e,t){const o=new Blob([e],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a");if(void 0!==s.download){const e=URL.createObjectURL(o);s.setAttribute("href",e),s.setAttribute("download",t),s.style.visibility="hidden",document.body.appendChild(s),s.click(),URL.revokeObjectURL(e),document.body.removeChild(s)}}clearAllFilters(){const e=document.getElementById("searchInput");e&&(e.value="",this.searchTerm="");const t=document.getElementById("tagSearchInput");t&&(t.value="");const o=document.getElementById("tagSearchClear");o&&(o.style.display="none"),this.filterTagCheckboxes(""),document.querySelector(".filter-tab.active")?.classList.remove("active"),this.currentFilter="ALL",this.renderSubcategoryTabs(null),this.advancedFilters={features:[],hasVideo:!1,regions:[],categories:[],subcategories:[]};document.querySelectorAll('#tagFilters input[type="checkbox"],#hasVideoFilter,#regionFilters input[type="checkbox"],#categoryFilters input[type="checkbox"],#subcategoryFilters input[type="checkbox"]').forEach(e=>e.checked=!1);const s=document.getElementById("headerRegionFilter");s&&(s.value="");const n=document.getElementById("headerCategoryFilter");n&&(n.value=""),this.filterAndDisplayTools(),this.updateFilterCount()}resetToDefaults(){this.clearAllFilters();const e=document.getElementById("sortFilter");e&&(e.value="name"),this.currentSort="name",document.querySelectorAll(".view-option").forEach(e=>e.classList.remove("active")),document.querySelector('.view-option[data-view="grid"]')?.classList.add("active"),this.currentView="grid";const t=document.getElementById("groupByFilter");t&&(t.value="category"),this.groupByCategory=!0,this.applyViewStyles(),this.filterAndDisplayTools()}updateFilterCount(){const{features:e,hasVideo:t,regions:o,categories:s,subcategories:n}=this.advancedFilters;let i=0;i+=e.length+o.length+s.length+n.length,t&&i++;const a=document.getElementById("filterCount");a&&(a.textContent=i>0?`(${i})`:"")}}let lastTouchEnd=0;document.addEventListener("touchend",function(e){const t=Date.now();t-lastTouchEnd<=300&&e.preventDefault(),lastTouchEnd=t},{passive:!1});