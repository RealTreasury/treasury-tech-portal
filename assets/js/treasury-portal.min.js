const EMBED_ORIGIN="https://realtreasury.com";let treasuryTechPortal;const portalRoot=document.querySelector(".treasury-portal")||document.body;function postHeight(){if(window.parent!==window){const e=Math.max(document.documentElement.scrollHeight,document.documentElement.offsetHeight,document.body.scrollHeight,document.body.offsetHeight,window.innerHeight);window.parent.postMessage({type:"treasury-height",height:e+100},"*");try{window.parent.postMessage({type:"treasury-height",height:e+100},EMBED_ORIGIN)}catch(e){}}}function debounce(e,t){let s;return function(){clearTimeout(s),s=setTimeout(e,t)}}const debouncedPostHeight=debounce(postHeight,100);function containsRecordIds(e){return Array.isArray(e)?e.some(containsRecordIds):e&&"object"==typeof e?Object.values(e).some(containsRecordIds):"string"==typeof e&&/^rec[0-9a-z]/i.test(e)}window.addEventListener("load",()=>{setTimeout(postHeight,100),setTimeout(postHeight,500),setTimeout(postHeight,1e3)}),window.addEventListener("resize",debouncedPostHeight),new ResizeObserver(()=>{debouncedPostHeight()}).observe(portalRoot),new MutationObserver(()=>{debouncedPostHeight()}).observe(portalRoot,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]}),document.addEventListener("DOMContentLoaded",async()=>{treasuryTechPortal=new TreasuryTechPortal,setTimeout(()=>{"function"==typeof postHeight&&postHeight()},1500),window.addEventListener("resize",()=>{window.innerWidth<=768?(treasuryTechPortal.sideMenuOpen&&treasuryTechPortal.closeSideMenu(),treasuryTechPortal.shortlistMenuOpen&&treasuryTechPortal.closeShortlistMenu()):treasuryTechPortal.renderShortlist(),setTimeout(()=>{"function"==typeof postHeight&&postHeight()},200)});const e=document.querySelectorAll(".rt-nav-item"),t=window.treasuryTechPortal;e.forEach(e=>{e.addEventListener("click",function(){t&&(t.sideMenuOpen&&t.closeSideMenu(),t.shortlistMenuOpen&&t.closeShortlistMenu())})}),document.addEventListener("click",function(e){(e.target.closest(".external-menu-toggle")||e.target.closest(".external-shortlist-toggle"))&&document.querySelectorAll(".rt-nav-item.active").forEach(e=>{e.classList.remove("active")})});const s=new URLSearchParams(window.location.search).get("tool");if(s&&document.cookie.includes("portal_access_token="))try{await treasuryTechPortal.toolsLoaded;const e=treasuryTechPortal.TREASURY_TOOLS.find(e=>e.name.toLowerCase()===decodeURIComponent(s).toLowerCase());e&&setTimeout(()=>treasuryTechPortal.showToolModal(e),500)}catch(e){console.error("Failed to load tools for deep link:",e)}});class TreasuryTechPortal{constructor(){this.TREASURY_TOOLS=[],this.toolsLoaded=this.fetchTools(),this.CATEGORY_INFO={CASH:{name:"Cash Tools",badge:"Essential",description:"Cash Tools are the essential first step for treasury teams moving away from manual spreadsheets. These platforms provide a single, unified view of bank balances and transactions through direct bank connections (via API or files). They excel at providing clear, real-time cash visibility and basic forecasting, allowing businesses to understand their current cash position and anticipate future needs without the complexity of a full TRMS.",features:["Bank Connectivity (API, SFTP)","Basic Forecasting Tools","Cash Visibility","Transaction Search, Sort, Tag, Group"],videoUrl:"https://realtreasury.com/wp-content/uploads/2025/08/Cash-Tools-Intro.mp4",videoPoster:"https://realtreasury.com/wp-content/uploads/2025/08/Cash-Tools-Intro.png"},LITE:{name:"Treasury Management System Lite (TMS-Lite)",badge:"Scalable",description:"TMS-Lite solutions bridge the gap between basic Cash Tools and enterprise TRMS platforms. They build upon cash visibility by adding crucial treasury functions like multi-currency cash positioning, initiating treasury payments (wires, transfers), and managing basic financial instruments like foreign exchange contracts. These systems are ideal for growing companies whose needs have outpaced simple cash tools but do not yet require the full complexity of an enterprise system.",features:["Bank Connectivity (API, SFTP)","Basic Forecasting Tools","Cash Visibility","Transaction Search, Sort, Tag, Group","Cash Positioning","Market Data","Treasury Payments (API, SFTP)"],videoUrl:"https://realtreasury.com/wp-content/uploads/2025/08/TMS-Lite-Intro.mp4",videoPoster:"https://realtreasury.com/wp-content/uploads/2025/08/TMS-Lite-Intro.png"},TRMS:{name:"Treasury & Risk Management Systems (TRMS)",badge:"Advanced",description:"Treasury & Risk Management Systems (TRMS) are comprehensive platforms for large, complex organizations. They offer a broad suite of tightly integrated modules far beyond cash visibility, covering debt and investment management, advanced financial risk analysis (FX, interest rates, commodities), hedge accounting, global payments, and in-house banking. These systems are designed to centralize and automate sophisticated treasury workflows.",features:["Bank Connectivity (API, SFTP)","Basic Forecasting Tools","Cash Visibility","Transaction Search, Sort, Tag, Group","Cash Positioning","Market Data","Treasury Payments (API, SFTP)","Derivatives (Interest, FX)","Intercompany Loans","Instrument Valuations","AI Forecasting","AI Insights","AP Payments","Bank Account Management","Basic FX (Spots, FWD)","Cash Accounting","Debt Management","Deal Accounting","In-House Banking","Investments","SWIFT Connectivity"],videoUrl:"https://realtreasury.com/wp-content/uploads/2025/08/TRMS-Intro.mp4",videoPoster:"https://realtreasury.com/wp-content/uploads/2025/08/TRMS-Intro.png"}};const e=["Bank Connectivity","Basic Forecasting Tools","Cash Visibility","Transaction Search, Sort, Tag, Group"],t=[...e,"Cash Positioning","Market Data","Treasury Payments"],s=[...t,"AI Forecasting","AI Insights","AP Payments","Bank Account Management","Basic FX (Spots, FWD)","Cash Accounting","Debt Management","Deal Accounting","In-House Banking","Investments","SWIFT Connectivity","Derivatives (Interest, FX)","Intercompany Loans","Instrument Valuations"];this.CATEGORY_TAGS={CASH:e,LITE:t,TRMS:s},this.enabledCategories=Array.isArray(window.TTP_DATA&&TTP_DATA.enabled_categories)&&TTP_DATA.enabled_categories.length?TTP_DATA.enabled_categories:["CASH","LITE","TRMS"],this.currentFilter="ALL",this.searchTerm="",this.filteredTools=[],this.allTags=[],this.allRegions=[],this.allCategories=[],this.allSubcategories=[],this.subcategoriesByCategory={},this.advancedFilters={features:[],hasVideo:!1,regions:[],categories:[],subcategories:[]},this.currentSort="name",this.currentView="grid",this.groupByCategory=!0,this.sideMenuOpen=!1,this.shortlist=[],this.shortlistMenuOpen=!1,this.touchDragTool=null,this.previousFocusedElement=null,this.videoTimes={},this.currentToolId=null,this.permanentToolPickerInitialized=!1,this.spaceHandler=null,this.handleOutsideSideMenuClick=e=>{const t=document.getElementById("sideMenu"),s=document.getElementById("sideMenuToggle"),o=document.getElementById("externalMenuToggle");!t||t.contains(e.target)||s?.contains(e.target)||o?.contains(e.target)||(e.stopPropagation(),this.closeSideMenu())},this.handleOutsideShortlistMenuClick=e=>{const t=document.getElementById("shortlistMenu"),s=document.getElementById("shortlistMenuToggle"),o=document.getElementById("externalShortlistToggle");!t||t.contains(e.target)||s?.contains(e.target)||o?.contains(e.target)||this.closeShortlistMenu()},this.init(),this.swipeStart=null,this.swipeThreshold=100,this.swipeVelocityThreshold=.3,window.addEventListener("message",e=>{if(e.origin.includes("youtube.com")&&"string"==typeof e.data)try{const t=JSON.parse(e.data);if("infoDelivery"===t.event&&"number"==typeof t.info&&t.id){const e=t.id.replace(/^yt-/,"");this.videoTimes[e]=t.info}}catch(e){}})}isMobile(){return window.matchMedia("(max-width: 768px)").matches}handleResponsive(){const e=this.isMobile();if(document.querySelectorAll(".tool-card").forEach(t=>{t.draggable=!e}),e){this.closeSideMenu(),this.closeShortlistMenu();const e=document.getElementById("externalMenuToggle"),t=document.getElementById("externalShortlistToggle");e&&(e.style.display="none"),t&&(t.style.display="none");const s=document.getElementById("bottomNav");s&&(s.style.display="flex")}else{const e=document.getElementById("externalMenuToggle"),t=document.getElementById("externalShortlistToggle");e&&(e.style.display="flex"),t&&(t.style.display="flex");const s=document.getElementById("bottomNav");s&&(s.style.display="none")}this.applyViewStyles()}normalizeCategory(e){const t=(e||"").toString().toUpperCase();return t.includes("CASH")?"CASH":t.includes("LITE")?"LITE":t.includes("TRMS")||t.includes("TMS")?"TRMS":""}async fetchTools(){const e=document.getElementById("loadingScreen"),t=document.querySelector(".treasury-portal .container"),s=document.getElementById("bottomNav");let o;e&&(e.classList.remove("fade-out"),e.style.display="none",o=setTimeout(()=>{e.style.display="block"},200));try{const e=new URL(TTP_DATA.rest_url),{regions:t=[],categories:s=[],subcategories:o=[]}=this.advancedFilters||{};t.forEach(t=>e.searchParams.append("region",t)),s.forEach(t=>e.searchParams.append("category",t)),o.forEach(t=>e.searchParams.append("sub_category",t));const n=await fetch(e.toString()),i=await n.json(),a=new Set,l=new Set,r=new Set,c={},d=(e,t)=>{const s="string"==typeof t?t.trim():"";s&&!/^\d+$/.test(s)&&e.add(s)};this.TREASURY_TOOLS=(Array.isArray(i)?i:[]).map(e=>{Array.isArray(e.regions)&&0!==e.regions.length||console.warn("Vendor missing regions:",e),e.category||Array.isArray(e.categories)&&0!==e.categories.length||console.warn("Vendor missing category:",e);let t="";Array.isArray(e.category)&&e.category.length>0?t=e.category[0]:e.category?t=e.category:Array.isArray(e.categories)&&e.categories.length>0?t=e.categories[0]:Array.isArray(e.category_names)&&e.category_names.length>0&&(t=e.category_names[0]);const s=this.normalizeCategory(t),o=Array.isArray(e.sub_categories)?e.sub_categories:[],n=Array.isArray(e.regions)?e.regions.map(e=>e.trim()):[];return d(l,t),c[s]||(c[s]=new Set),o.forEach(e=>{d(r,e),d(c[s],e)}),n.forEach(e=>d(a,e)),{name:e.name||"",desc:e.status||"",category:s,categoryName:t,subCategories:o,regions:n,videoUrl:e.video_url||"",websiteUrl:e.full_website_url||e.website||"",logoUrl:e.logo_url||"",capabilities:e.capabilities||[],target:""}}),this.allRegions=Array.from(a).sort((e,t)=>e.localeCompare(t)),this.allCategories=Array.from(l).sort((e,t)=>e.localeCompare(t)),this.allSubcategories=Array.from(r).sort((e,t)=>e.localeCompare(t)),this.subcategoriesByCategory={},Object.keys(c).forEach(e=>{this.subcategoriesByCategory[e]=Array.from(c[e]).sort((e,t)=>e.localeCompare(t))}),this.updateCounts(),this.populateCategoryTags(),this.populateRegionFilters(),this.populateCategoryFilters(),this.populateSubcategoryFilters(),this.renderHeaderFilters(),this.renderSubcategoryTabs("ALL"===this.currentFilter?null:this.currentFilter),this.filterAndDisplayTools(),this.applyViewStyles()}catch(e){console.error("Failed to load tools:",e)}finally{t&&t.classList.add("loaded"),s&&(s.style.display="flex"),e&&(clearTimeout(o),"none"!==e.style.display&&(e.classList.add("fade-out"),e.addEventListener("transitionend",()=>{e.style.display="none"},{once:!0})))}}init(){this.setupInteractions(),this.setupSearch(),this.setupModals(),this.setupSideMenu(),this.setupShortlistMenu(),this.setupBottomNav(),this.handleResponsive(),window.addEventListener("resize",()=>this.handleResponsive())}handleTouchStart(e,t){this.isMobile()&&(this.swipeStart={x:e.touches[0].clientX,y:e.touches[0].clientY,time:Date.now(),element:t})}handleTouchMove(e,t){if(!this.swipeStart||!this.isMobile())return;const s=Math.abs(e.touches[0].clientX-this.swipeStart.x);s>Math.abs(e.touches[0].clientY-this.swipeStart.y)&&s>10&&e.preventDefault()}handleTouchEnd(e,t,s){if(!this.swipeStart||!this.isMobile())return;const o=e.changedTouches[0].clientX,n=e.changedTouches[0].clientY,i=o-this.swipeStart.x,a=n-this.swipeStart.y,l=Date.now()-this.swipeStart.time,r=Math.abs(i),c=Math.abs(a);if(Math.max(r,c)/l>this.swipeVelocityThreshold&&l<1e3){let e=!1;("sideMenu"===t&&i<-this.swipeThreshold||"shortlistMenu"===t&&i>this.swipeThreshold||("toolModal"===t||"categoryModal"===t)&&a>this.swipeThreshold)&&(e=!0),e&&s&&s()}this.swipeStart=null}setupSwipeToClose(e,t,s){const o=document.getElementById(e);if(!o)return;const n=e=>this.handleTouchStart(e,t),i=e=>this.handleTouchMove(e,t),a=e=>this.handleTouchEnd(e,t,s);o.addEventListener("touchstart",n,{passive:!1}),o.addEventListener("touchmove",i,{passive:!1}),o.addEventListener("touchend",a,{passive:!1}),o._swipeHandlers={touchstart:n,touchmove:i,touchend:a}}setupInteractions(){document.querySelectorAll(".category-header").forEach(e=>{e.addEventListener("click",t=>{if(t.target.closest(".show-more-category-tags-btn")||t.target.closest(".show-less-category-tags-btn"))return;const s=e.dataset.category;s&&this.CATEGORY_INFO[s]&&this.showCategoryModal(this.CATEGORY_INFO[s],s)})}),document.getElementById("mainContent").addEventListener("click",e=>{if(e.target.classList.contains("show-more-capabilities-btn")){e.stopPropagation();const t=e.target.dataset.toolName,s=this.TREASURY_TOOLS.find(e=>e.name===t);if(s){const t=e.target.parentElement,o=[...s.capabilities].sort((e,t)=>e.localeCompare(t));t.innerHTML=o.map(e=>`<span class="tool-capability">${e}</span>`).join(""),t.innerHTML+=`<button class="show-less-capabilities-btn" data-tool-name="${s.name}">Show less</button>`}}else if(e.target.classList.contains("show-less-capabilities-btn")){e.stopPropagation();const t=e.target.dataset.toolName,s=this.TREASURY_TOOLS.find(e=>e.name===t);if(s){const t=e.target.parentElement,o=[...s.capabilities].sort((e,t)=>e.localeCompare(t)),n=o.slice(0,3),i=o.length>3;t.innerHTML=n.map(e=>`<span class="tool-capability">${e}</span>`).join(""),i&&(t.innerHTML+=`<button class="show-more-capabilities-btn" data-tool-name="${s.name}">... more</button>`)}}else if(e.target.classList.contains("show-more-category-tags-btn")){e.stopPropagation();const t=e.target.dataset.category,s=e.target.parentElement,o=[...this.CATEGORY_TAGS[t]||[]].sort((e,t)=>e.localeCompare(t));s.innerHTML=o.map(e=>`<span class="category-tag">${e}</span>`).join(""),s.innerHTML+=`<button class="show-less-category-tags-btn" data-category="${t}">Show less</button>`}else if(e.target.classList.contains("show-less-category-tags-btn")){e.stopPropagation();const t=e.target.dataset.category,s=e.target.parentElement,o=[...this.CATEGORY_TAGS[t]||[]].sort((e,t)=>e.localeCompare(t)),n=o.slice(0,3),i=o.length>3;s.innerHTML=n.map(e=>`<span class="category-tag">${e}</span>`).join(""),i&&(s.innerHTML+=`<button class="show-more-category-tags-btn" data-category="${t}">... more</button>`)}})}setupSearch(){const e=document.getElementById("searchInput"),t=document.getElementById("searchClear");e&&(e.addEventListener("input",e=>{this.searchTerm=e.target.value.toLowerCase(),t&&(t.style.display=this.searchTerm?"block":"none"),this.filterAndDisplayTools()}),e.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),this.closeSideMenu())})),t&&t.addEventListener("click",()=>{e&&(e.value="",e.focus()),this.searchTerm="",t.style.display="none",this.filterAndDisplayTools()})}setupTagSearch(){const e=document.getElementById("tagSearchInput"),t=document.getElementById("tagSearchClear");e&&e.addEventListener("input",()=>{const s=e.value.toLowerCase();t&&(t.style.display=s?"block":"none"),this.filterTagCheckboxes(s)}),t&&t.addEventListener("click",()=>{e&&(e.value="",e.focus()),t.style.display="none",this.filterTagCheckboxes("")})}filterTagCheckboxes(e){const t=document.getElementById("tagFilters");if(!t)return;t.querySelectorAll(".checkbox-item").forEach(t=>{const s=t.textContent.toLowerCase();t.style.display=s.includes(e)?"flex":"none"});const s=document.getElementById("showMoreTagFilters"),o=document.getElementById("showLessTagFilters"),n=document.getElementById("extraTagFilters");s&&o&&n&&(e?(n.style.display="block",s.style.display="none",o.style.display="none"):(n.style.display="none",o.style.display="none",s.style.display="inline-block"))}setupModals(){const e=document.getElementById("toolModal"),t=document.getElementById("modalClose");t&&t.addEventListener("click",()=>this.closeModal("toolModal")),e&&e.addEventListener("click",e=>{null===e.target.closest(".ttp-modal-content")&&this.closeModal("toolModal")});const s=document.getElementById("categoryModal"),o=document.getElementById("categoryModalClose");o&&o.addEventListener("click",()=>this.closeModal("categoryModal")),s&&s.addEventListener("click",e=>{null===e.target.closest(".ttp-modal-content")&&this.closeModal("categoryModal")});const n=document.querySelector(".treasury-portal"),i=n?.querySelector(".intro-video-target")||n,a=i?.getAttribute("data-video-src")||"",l=i?.getAttribute("data-poster")||"",r=(e,t)=>{const s=document.createElement("div");s.className="video-wrapper";const o=document.createElement("video");o.src=e,o.autoplay=!1,o.muted=!1,o.playsInline=!0,o.preload="metadata",o.setAttribute("playsinline",""),t&&(o.poster=t);const n=document.createElement("button");n.className="video-play-button",n.setAttribute("aria-label","Play video"),n.innerHTML="‚ñ∂";const i=()=>{o.paused?o.play():o.pause()};return o.addEventListener("click",i),n.addEventListener("click",e=>{e.stopPropagation(),i()}),o.addEventListener("play",()=>s.classList.add("playing")),o.addEventListener("pause",()=>s.classList.remove("playing")),o.addEventListener("ended",()=>s.classList.remove("playing")),s.appendChild(o),s.appendChild(n),s},c=()=>{i.innerHTML='<div class="intro-video-fallback">Intro video unavailable</div>'};if(a){const e=r(a,l);e.querySelector("video").onerror=c,i.innerHTML="",i.appendChild(e)}else c();document.querySelectorAll(".category-video-target").forEach(e=>{const t=e.getAttribute("data-video-src"),s=e.getAttribute("data-poster");if(t){const o=r(t,s);e.innerHTML="",e.appendChild(o)}}),this.setupSwipeToClose("toolModal","toolModal",()=>this.closeModal("toolModal")),this.setupSwipeToClose("categoryModal","categoryModal",()=>this.closeModal("categoryModal")),document.addEventListener("keydown",e=>{"Escape"===e.key&&(this.closeModal("toolModal"),this.closeModal("categoryModal"))})}openModal(e){if(e){this.previousFocusedElement=document.activeElement,e.classList.add("show"),portalRoot.classList.add("modal-open");const t=e.querySelector('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])');if(t)t.focus();else{const t=e.querySelector(".ttp-modal-content");t&&t.focus()}}}showToolModal(e){const t=document.getElementById("toolModal"),s=document.getElementById("modalTitle"),o=document.getElementById("modalDescription"),n=document.getElementById("modalWebsiteLink"),i=t?.querySelector(".modal-body"),a=document.getElementById("modalToolLogo"),l=document.getElementById("modalCapabilities");if(!t||!i)return;if(this.spaceHandler&&(this.spaceHandler.el.removeEventListener("keydown",this.spaceHandler.fn),this.spaceHandler=null),this.currentToolId=e.name.toLowerCase().replace(/[^a-z0-9]+/g,"-"),s&&(s.textContent=e.name),o&&(o.textContent=e.desc),n&&(e.websiteUrl?(n.href=e.websiteUrl,n.style.display="inline-flex"):n.style.display="none"),a&&(e.logoUrl?e.websiteUrl?a.outerHTML=`<a href="${e.websiteUrl}" target="_blank" rel="noopener noreferrer" class="modal-logo-link">\n                                <img id="modalToolLogo" class="modal-tool-logo" src="${e.logoUrl}" alt="${e.name} logo">\n                            </a>`:(a.src=e.logoUrl,a.alt=`${e.name} logo`,a.style.display="block",a.parentElement.classList.contains("modal-logo-link")&&a.parentElement.replaceWith(a)):a.style.display="none",e.websiteUrl&&e.logoUrl&&setTimeout(()=>{const e=document.querySelector(".modal-logo-link");e&&e.addEventListener("click",e=>{e.stopPropagation()})},0)),l){const t=[...e.capabilities||[]].sort((e,t)=>e.localeCompare(t)),s=t.slice(0,5),o=t.length>5;l.innerHTML=s.map(e=>`<span class="tool-capability">${e}</span>`).join(""),o&&(l.innerHTML+=`<button class="show-more-modal-capabilities-btn" data-tool-name="${e.name}">... more (${t.length-5})</button>`),l.addEventListener("click",e=>{if(e.target.classList.contains("show-more-modal-capabilities-btn")){e.stopPropagation();const t=e.target.dataset.toolName,s=this.TREASURY_TOOLS.find(e=>e.name===t);if(s){const e=[...s.capabilities||[]].sort((e,t)=>e.localeCompare(t));l.innerHTML=e.map(e=>`<span class="tool-capability">${e}</span>`).join(""),l.innerHTML+=`<button class="show-less-modal-capabilities-btn" data-tool-name="${t}">Show less</button>`}}else if(e.target.classList.contains("show-less-modal-capabilities-btn")){e.stopPropagation();const t=e.target.dataset.toolName,s=this.TREASURY_TOOLS.find(e=>e.name===t);if(s){const e=[...s.capabilities||[]].sort((e,t)=>e.localeCompare(t)),o=e.slice(0,5),n=e.length>5;l.innerHTML=o.map(e=>`<span class="tool-capability">${e}</span>`).join(""),n&&(l.innerHTML+=`<button class="show-more-modal-capabilities-btn" data-tool-name="${t}">... more (${e.length-5})</button>`)}}})}const r=i.querySelector(".video-demo-section");if(r&&r.remove(),e.videoUrl){const t=document.createElement("div");t.className="feature-section video-demo-section";const s=this.videoTimes[this.currentToolId]||0;if(e.videoUrl.includes("youtu.be/")||e.videoUrl.includes("youtube.com/watch")){let o=e.videoUrl;if(e.videoUrl.includes("youtu.be/")){o=`https://www.youtube.com/embed/${e.videoUrl.split("youtu.be/")[1].split("?")[0]}`}else{o=`https://www.youtube.com/embed/${new URL(e.videoUrl).searchParams.get("v")}`}o+=(o.includes("?")?"&":"?")+"enablejsapi=1&playsinline=1",s&&(o+=`&start=${Math.floor(s)}&autoplay=1`),t.innerHTML=`\n                            <h4>üé• Product Differentiator</h4>\n                            <div class="video-container">\n                                <iframe id="yt-${this.currentToolId}" src="${o}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy" playsinline></iframe>\n                            </div>\n                        `}else t.innerHTML=`\n                            <h4>üé• Product Differentiator</h4>\n                            <div class="video-container">\n                                <video src="${e.videoUrl}" controls playsinline></video>\n                            </div>\n                        `,s&&(t.querySelector("video").currentTime=s);const o=l?.closest(".feature-section");o?i.insertBefore(t,o):i.appendChild(t)}this.openModal(t);const c=t.querySelector(".modal-content, .ttp-modal-content");if(c){const e=e=>{if("Space"===e.code||" "===e.key){const s=t.querySelector("video"),o=t.querySelector("iframe");s?(e.preventDefault(),s.paused?s.play():s.pause()):o&&o.contentWindow&&(e.preventDefault(),o.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}',"https://www.youtube.com"))}};c.addEventListener("keydown",e),this.spaceHandler={el:c,fn:e}}}showCategoryModal(e,t){const s=document.getElementById("categoryModal"),o=document.getElementById("categoryModalTitle"),n=document.getElementById("categoryModalDescription"),i=document.getElementById("categoryModalFeatures"),a=s?.querySelector(".modal-body");o&&(o.textContent=e.name),n&&(n.textContent=e.description),i&&(i.innerHTML="",e.features.forEach(e=>{const t=document.createElement("li");t.textContent=e,i.appendChild(t)}));const l=a?.querySelector(".video-demo-section");if(l&&l.remove(),e.videoUrl&&a){const t=document.createElement("div");t.className="feature-section video-demo-section";let s="";if(e.videoUrl.includes("youtu.be/")||e.videoUrl.includes("youtube.com/watch")){let t=e.videoUrl;if(e.videoUrl.includes("youtu.be/")){t=`https://www.youtube.com/embed/${e.videoUrl.split("youtu.be/")[1].split("?")[0]}`}else if(e.videoUrl.includes("youtube.com/watch")){t=`https://www.youtube.com/embed/${new URL(e.videoUrl).searchParams.get("v")}`}t+=(t.includes("?")?"&":"?")+"enablejsapi=1&playsinline=1",s=`<iframe src="${t}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy" playsinline></iframe>`}else{s=`<video controls preload="metadata"${e.videoPoster?` poster="${e.videoPoster}"`:""} playsinline>\n                                        <source src="${e.videoUrl}" type="video/mp4">\n                                        Your browser does not support the video tag.\n                                      </video>`}t.innerHTML=`\n                        <h4>üé• Category Overview Video</h4>\n                        <div class="video-container">\n                             ${s}\n                        </div>\n                    `,a.insertBefore(t,a.firstChild)}this.openModal(s)}closeModal(e){const t=document.getElementById(e);if(t&&t.classList.contains("show")){if(t.classList.remove("show"),portalRoot.classList.remove("modal-open"),"toolModal"===e&&this.currentToolId){const e=this.currentToolId;t.querySelectorAll("iframe").forEach(t=>{t.src.includes("youtube.com")&&t.contentWindow&&(t.contentWindow.postMessage(JSON.stringify({event:"command",func:"getCurrentTime",id:`yt-${e}`}),"https://www.youtube.com"),t.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}',"https://www.youtube.com"))}),t.querySelectorAll("video").forEach(t=>{this.videoTimes[e]=t.currentTime,t.pause()}),this.spaceHandler&&(this.spaceHandler.el.removeEventListener("keydown",this.spaceHandler.fn),this.spaceHandler=null)}this.previousFocusedElement&&(this.previousFocusedElement.focus(),this.previousFocusedElement=null)}}filterAndDisplayTools(){let e=this.TREASURY_TOOLS.filter(e=>this.enabledCategories.includes(e.category));if(this.searchTerm){const t=this.searchTerm.toLowerCase();e=e.filter(e=>[e.name,e.desc,e.target,...e.capabilities||[]].join(" ").toLowerCase().includes(t))}else e="ALL"===this.currentFilter?e:e.filter(e=>e.category===this.currentFilter);const{regions:t,categories:s,subcategories:o}=this.advancedFilters;t.length&&(e=e.filter(e=>(e.regions||[]).some(e=>t.includes(e)))),s.length&&(e=e.filter(e=>s.includes(e.categoryName))),o.length&&(e=e.filter(e=>(e.subCategories||[]).some(e=>o.includes(e)))),this.advancedFilters.features.length&&(e=e.filter(e=>this.advancedFilters.features.every(t=>(e.capabilities||[]).includes(t)))),this.advancedFilters.hasVideo&&(e=e.filter(e=>e.videoUrl)),"name"===this.currentSort?e=e.sort((e,t)=>e.name.localeCompare(t.name)):"category"===this.currentSort&&(e=e.sort((e,t)=>e.category.localeCompare(t.category))),this.filteredTools=e,this.displayFilteredTools(),this.updateVisibleCounts()}displayFilteredTools(){const e=this.enabledCategories,t=this.filteredTools.length>0,s=document.getElementById("noResults");s&&(s.style.display=t?"none":"block");const o=document.getElementById("listViewContainer");if(!this.groupByCategory||this.searchTerm||this.advancedFilters.features.length||this.advancedFilters.hasVideo||this.advancedFilters.regions.length||this.advancedFilters.categories.length||this.advancedFilters.subcategories.length)return e.forEach(e=>{const t=document.querySelector(`.category-section[data-category="${e}"]`);t&&(t.style.display="none")}),void(o&&(o.innerHTML="",this.filteredTools.sort((e,t)=>e.name.localeCompare(t.name)).forEach(e=>{const t=this.createToolCard(e,e.category);o.appendChild(t)}),o.style.display=t?"grid":"none"));o&&(o.style.display="none"),e.forEach(e=>{const t=document.querySelector(`.category-section[data-category="${e}"]`),s=document.getElementById(`tools-${e}`),o=this.filteredTools.filter(t=>t.category===e).sort((e,t)=>e.name.localeCompare(t.name));s&&(s.innerHTML="");let n=!1;n=(this.searchTerm||"ALL"===this.currentFilter||this.currentFilter===e)&&o.length>0,t&&(t.style.display=n?"block":"none"),n&&s&&o.forEach(t=>{const o=this.createToolCard(t,e);s.appendChild(o)})})}createToolCard(e,t){const s=document.createElement("div");s.className=`tool-card tool-${t.toLowerCase()}`,s.draggable=!this.isMobile(),s.dataset.name=e.name;const o=containsRecordIds(e)||e.incomplete?'<span class="ttp-warning" title="Some data may be incomplete">‚ö†Ô∏è</span>':"",n=[...e.capabilities||[]].sort((e,t)=>e.localeCompare(t)),i=n.slice(0,3),a=n.length>3;if(s.innerHTML=`\n                    <div class="tool-card-content">\n                        <div class="tool-header">\n                            <div class="tool-info">\n                                <div class="tool-name">\n                                    <div class="tool-name-group">\n                                        <span class="tool-name-title">${e.name}</span>${o}\n                                    </div>\n                                    ${e.logoUrl?`<a href="${e.websiteUrl||"#"}" target="_blank" rel="noopener noreferrer" class="tool-logo-link" ${e.websiteUrl?"":'style="pointer-events: none; cursor: default;"'}><img class="tool-logo-inline" src="${e.logoUrl}" alt="${e.name} logo"></a>`:""}\n                                    <div class="tool-actions">\n                                        <div class="tool-icon">${{TRMS:"üè¢",CASH:"üí∞",LITE:"‚ö°"}[e.category]}</div>\n                                    </div>\n                                </div>\n                                ${e.videoUrl?'<button type="button" class="video-indicator">‚ñ∂ Demo</button>':""}\n                                <div class="tool-type">${"CASH"===e.category?"Cash Tools":"LITE"===e.category?"TMS-Lite":e.category}</div>\n                            </div>\n                        </div>\n                        <div class="tool-description">${e.desc}</div>\n                    </div>\n                        <div class="tool-card-actions">\n                        <div class="tool-capabilities">\n                            ${i.map(e=>`<span class="tool-capability">${e}</span>`).join("")}\n                            ${a?`<button class="show-more-capabilities-btn" data-tool-name="${e.name}">... more</button>`:""}\n                        </div>\n                    </div>\n                `,s.addEventListener("click",t=>{t.target.closest(".show-more-capabilities-btn")||t.target.closest(".show-less-capabilities-btn")||this.showToolModal(e)}),this.isMobile()||(s.addEventListener("dragstart",t=>{t.dataTransfer.setData("text/plain",e.name),this.openShortlistMenu("dragstart")}),s.addEventListener("touchstart",()=>{this.touchDragTool=e,this.openShortlistMenu()}),s.addEventListener("touchmove",e=>{const t=document.getElementById("shortlistContainer");if(!t)return;const s=e.touches[0],o=document.elementFromPoint(s.clientX,s.clientY);o&&t.contains(o)?t.classList.add("drag-over"):t.classList.remove("drag-over"),e.preventDefault()},{passive:!1}),s.addEventListener("touchend",e=>{const t=document.getElementById("shortlistContainer");if(t&&t.classList.remove("drag-over"),this.touchDragTool&&t){const s=e.changedTouches[0],o=document.elementFromPoint(s.clientX,s.clientY);o&&t.contains(o)&&!this.shortlist.some(e=>e.tool.name===this.touchDragTool.name)&&(this.shortlist.push({tool:this.touchDragTool,notes:""}),this.renderShortlist())}this.touchDragTool=null})),e.websiteUrl){const e=s.querySelector(".tool-logo-link");e&&e.addEventListener("click",e=>{e.stopPropagation()})}return s}populateCategoryTags(){this.enabledCategories.forEach(e=>{const t=document.getElementById(`category-tags-${e}`);if(t){const s=[...this.CATEGORY_TAGS[e]||[]].sort((e,t)=>e.localeCompare(t)),o=s.slice(0,3),n=s.length>3;t.innerHTML=o.map(e=>`<span class="category-tag">${e}</span>`).join(""),n&&(t.innerHTML+=`<button class="show-more-category-tags-btn" data-category="${e}">... more</button>`)}})}populateTagFilters(){const e=document.getElementById("tagFilters");if(!e)return;const t=[...new Set(Object.values(this.CATEGORY_TAGS).flat())].sort((e,t)=>e.localeCompare(t));this.allTags=t;const s=t.slice(0,4),o=t.slice(4),n=e=>{const t=`tag-${e.replace(/[^a-z0-9]+/gi,"-").toLowerCase()}`;return`<div class="checkbox-item"><input type="checkbox" id="${t}" value="${e}"><label for="${t}">${e}</label></div>`};e.innerHTML=s.map(n).join(""),o.length&&(e.innerHTML+=`<div id="extraTagFilters" style="display:none;">${o.map(n).join("")}</div>`,e.innerHTML+='<button class="show-more-filter-tags-btn" id="showMoreTagFilters">Show more</button>',e.innerHTML+='<button class="show-less-filter-tags-btn" id="showLessTagFilters" style="display:none;">Show less</button>')}populateRegionFilters(){const e=document.getElementById("regionFilters");if(!e)return;e.innerHTML=this.allRegions.map(e=>{const t=`region-${e.replace(/[^a-z0-9]+/gi,"-").toLowerCase()}`;return`<div class="checkbox-item"><input type="checkbox" id="${t}" value="${e}"><label for="${t}">${e}</label></div>`}).join("");const t=e.querySelectorAll('input[type="checkbox"]');t.forEach(e=>{e.addEventListener("change",()=>{this.advancedFilters.regions=Array.from(t).filter(e=>e.checked).map(e=>e.value),this.filterAndDisplayTools(),this.updateFilterCount()})})}populateCategoryFilters(){const e=document.getElementById("categoryFilters");if(!e)return;e.innerHTML=this.allCategories.map(e=>{const t=`cat-${e.replace(/[^a-z0-9]+/gi,"-").toLowerCase()}`;return`<div class="checkbox-item"><input type="checkbox" id="${t}" value="${e}"><label for="${t}">${e}</label></div>`}).join("");const t=e.querySelectorAll('input[type="checkbox"]');t.forEach(e=>{e.addEventListener("change",()=>{this.advancedFilters.categories=Array.from(t).filter(e=>e.checked).map(e=>e.value),this.currentFilter=1===this.advancedFilters.categories.length?this.normalizeCategory(this.advancedFilters.categories[0]):"ALL",this.renderSubcategoryTabs("ALL"===this.currentFilter?null:this.currentFilter),this.filterAndDisplayTools(),this.updateFilterCount()})})}populateSubcategoryFilters(){const e=document.getElementById("subcategoryFilters");if(!e)return;e.innerHTML=this.allSubcategories.map(e=>{const t=`sub-${e.replace(/[^a-z0-9]+/gi,"-").toLowerCase()}`;return`<div class="checkbox-item"><input type="checkbox" id="${t}" value="${e}"><label for="${t}">${e}</label></div>`}).join("");const t=e.querySelectorAll('input[type="checkbox"]');t.forEach(e=>{e.addEventListener("change",()=>{this.advancedFilters.subcategories=Array.from(t).filter(e=>e.checked).map(e=>e.value),this.filterAndDisplayTools(),this.updateFilterCount()})})}renderSubcategoryTabs(e){const t=document.querySelector(".filter-tabs");if(!t)return;if(t.innerHTML="",t.style.display="none",this.advancedFilters.subcategories=[],!e||!this.subcategoriesByCategory[e])return;const s=this.subcategoriesByCategory[e];if(!s.length)return;t.style.display="flex";const o=(e,t="")=>{const s=document.createElement("button");return s.type="button",s.className="filter-tab",s.textContent=e,s.dataset.subcategory=t,s},n=o("All");n.classList.add("active"),t.appendChild(n),s.forEach(e=>t.appendChild(o(e,e))),t.querySelectorAll(".filter-tab").forEach(e=>{e.addEventListener("click",e=>{t.querySelector(".filter-tab.active")?.classList.remove("active"),e.target.classList.add("active");const s=e.target.dataset.subcategory;this.advancedFilters.subcategories=s?[s]:[],this.filterAndDisplayTools(),this.updateFilterCount()})})}renderHeaderFilters(){const e=document.getElementById("headerFilters");if(!e)return;const t=['<option value="">All Regions</option>',...this.allRegions.map(e=>`<option value="${e}">${e}</option>`)],s=['<option value="">All Categories</option>',...this.allCategories.map(e=>`<option value="${e}">${e}</option>`)];e.innerHTML=`\n                    <select id="headerRegionFilter" class="header-filter">${t.join("")}</select>\n                    <select id="headerCategoryFilter" class="header-filter">${s.join("")}</select>\n                `;const o=e.querySelector("#headerRegionFilter"),n=e.querySelector("#headerCategoryFilter");o.addEventListener("change",e=>{const t=e.target.value;this.advancedFilters.regions=t?[t]:[],this.filterAndDisplayTools(),this.updateFilterCount()}),n.addEventListener("change",e=>{const t=e.target.value;this.advancedFilters.categories=t?[t]:[],this.currentFilter=1===this.advancedFilters.categories.length?this.normalizeCategory(this.advancedFilters.categories[0]):"ALL",this.renderSubcategoryTabs("ALL"===this.currentFilter?null:this.currentFilter),this.filterAndDisplayTools(),this.updateFilterCount()})}updateVisibleCounts(){const e=this.enabledCategories.map(e=>{const t=this.filteredTools.filter(t=>t.category===e).length,s=document.getElementById(`count-${e}`);return s&&(s.textContent=t),t}),t=this.filteredTools.length,s=this.searchTerm||this.advancedFilters.features.length||this.advancedFilters.hasVideo||this.advancedFilters.regions.length||this.advancedFilters.categories.length||this.advancedFilters.subcategories.length,o=document.getElementById("totalTools");o&&(o.textContent=s?t:this.TREASURY_TOOLS.length);const n=document.getElementById("totalCategories");if(n)if(s){const e=new Set(this.filteredTools.map(e=>e.categoryName).filter(Boolean));n.textContent=e.size}else n.textContent=this.allCategories.length;const i=e.reduce((e,t)=>e+t,0);s&&i!==t&&console.warn(`Category counts (${i}) do not sum to visible total (${t})`)}updateCounts(){this.enabledCategories.forEach(e=>{const t=this.TREASURY_TOOLS.filter(t=>t.category===e).length,s=document.getElementById(`count-${e}`);s&&(s.textContent=t)});const e=document.getElementById("totalTools");e&&(e.textContent=this.TREASURY_TOOLS.length);const t=document.getElementById("totalCategories");t&&(t.textContent=this.allCategories.length)}setupSideMenu(){const e=document.getElementById("sideMenuToggle"),t=document.getElementById("externalMenuToggle"),s=document.getElementById("sideMenu"),o=document.getElementById("sideMenuOverlay");e&&e.addEventListener("click",()=>this.toggleSideMenu()),t&&t.addEventListener("click",()=>this.toggleSideMenu()),o&&o.addEventListener("click",()=>this.closeSideMenu()),s&&s.addEventListener("click",e=>{this.isMobile()||this.sideMenuOpen||e.target!==s||(e.stopPropagation(),this.openSideMenu())}),this.setupSwipeToClose("sideMenu","sideMenu",()=>this.closeSideMenu()),this.setupAdvancedFilters(),this.setupViewOptions(),this.setupQuickActions(),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.sideMenuOpen&&this.closeSideMenu()})}setupAdvancedFilters(){this.populateTagFilters(),this.setupTagSearch();const e=document.getElementById("showMoreTagFilters"),t=document.getElementById("showLessTagFilters"),s=document.getElementById("extraTagFilters");e&&t&&s&&(e.addEventListener("click",()=>{s.style.display="block",e.style.display="none",t.style.display="inline-block"}),t.addEventListener("click",()=>{s.style.display="none",t.style.display="none",e.style.display="inline-block"}));document.querySelectorAll('#tagFilters input[type="checkbox"]').forEach(e=>{e.addEventListener("change",()=>{this.updateFeatureFilters(),this.filterAndDisplayTools(),this.updateFilterCount()})});const o=document.getElementById("hasVideoFilter");o&&o.addEventListener("change",e=>{this.advancedFilters.hasVideo=e.target.checked,this.filterAndDisplayTools(),this.updateFilterCount()});const n=document.getElementById("sortFilter");n&&n.addEventListener("change",e=>{this.currentSort=e.target.value,this.filterAndDisplayTools()})}setupViewOptions(){const e=document.querySelectorAll(".view-option");e.forEach(t=>{t.addEventListener("click",()=>{e.forEach(e=>e.classList.remove("active")),t.classList.add("active"),this.currentView=t.dataset.view,this.applyViewStyles()})});const t=document.getElementById("groupByFilter");t&&t.addEventListener("change",e=>{this.groupByCategory="category"===e.target.value,this.filterAndDisplayTools()})}setupQuickActions(){const e=document.getElementById("clearAllFilters");e&&e.addEventListener("click",()=>this.clearAllFilters());const t=document.getElementById("resetToDefaults");t&&t.addEventListener("click",()=>this.resetToDefaults());const s=document.getElementById("applyFilters");s&&s.addEventListener("click",()=>{this.filterAndDisplayTools(),this.closeSideMenu()})}toggleSideMenu(){this.sideMenuOpen?this.closeSideMenu():this.openSideMenu()}openSideMenu(){this.closeShortlistMenu();const e=document.getElementById("sideMenu"),t=document.getElementById("sideMenuOverlay"),s=document.getElementById("sideMenuToggle"),o=document.getElementById("externalMenuToggle");e?.classList.add("open"),portalRoot.classList.add("side-menu-open"),t?.classList.add("show"),s?.classList.add("active"),o&&(o.classList.add("active"),o.style.display="none"),this.isMobile()?(document.body.style.overflow="hidden",document.body.style.position="fixed",document.body.style.width="100%"):portalRoot.style.overflow="hidden",document.addEventListener("click",this.handleOutsideSideMenuClick,!0),this.sideMenuOpen=!0}closeSideMenu(){const e=document.getElementById("sideMenu"),t=document.getElementById("sideMenuOverlay"),s=document.getElementById("sideMenuToggle"),o=document.getElementById("externalMenuToggle");e?.classList.remove("open"),t?.classList.remove("show"),s?.classList.remove("active"),o&&(o.classList.remove("active"),o.style.display=this.isMobile()?"none":"flex"),portalRoot.classList.remove("side-menu-open"),this.isMobile()?(document.body.style.overflow="",document.body.style.position="",document.body.style.width=""):portalRoot.style.overflow="",document.removeEventListener("click",this.handleOutsideSideMenuClick,!0),this.sideMenuOpen=!1}setupShortlistMenu(){const e=document.getElementById("shortlistMenuToggle"),t=document.getElementById("shortlistMenuOverlay"),s=document.getElementById("externalShortlistToggle"),o=document.getElementById("shortlistContainer"),n=document.getElementById("clearShortlist"),i=document.getElementById("exportShortlistBtn");e&&e.addEventListener("click",()=>this.toggleShortlistMenu()),s&&s.addEventListener("click",()=>this.toggleShortlistMenu()),t&&(t.addEventListener("dragover",e=>e.preventDefault()),t.addEventListener("drop",e=>e.preventDefault())),this.setupSwipeToClose("shortlistMenu","shortlistMenu",()=>this.closeShortlistMenu());const a=document.getElementById("shortlistMenu");if(a&&a.addEventListener("click",e=>{this.isMobile()||this.shortlistMenuOpen||e.target!==a||(e.stopPropagation(),this.openShortlistMenu())}),n&&n.addEventListener("click",()=>this.clearShortlist()),i&&i.addEventListener("click",()=>this.exportShortlist()),o){let e=null,t=null,s=null,n=null;const i=()=>o.classList.add("drag-over"),a=()=>o.classList.remove("drag-over");o.addEventListener("dragstart",t=>{t.target.classList.contains("shortlist-card")?(e=t.target,t.dataTransfer.setData("text/plain",t.target.dataset.name),t.dataTransfer.effectAllowed="move",t.dataTransfer.setDragImage(new Image,0,0),s=t.target.cloneNode(!0),s.classList.add("drag-preview"),s.style.width=`${t.target.offsetWidth}px`,s.style.height=`${t.target.offsetHeight}px`,portalRoot.appendChild(s),n=e=>{s.style.left=`${e.clientX}px`,s.style.top=`${e.clientY}px`},window.addEventListener("pointermove",n),n(t)):e=null}),o.addEventListener("dragenter",i),o.addEventListener("dragleave",e=>{e.target===o&&a()}),o.addEventListener("dragover",t=>{if(t.preventDefault(),e){const s=t.target.closest(".shortlist-card");if(s&&s!==e){const n=s.getBoundingClientRect(),i=t.clientY-n.top>n.height/2;o.insertBefore(e,i?s.nextSibling:s)}}}),o.addEventListener("drop",t=>{if(t.preventDefault(),a(),e)this.shortlist=Array.from(o.querySelectorAll(".shortlist-card")).map(e=>{const t=e.dataset.name;return this.shortlist.find(e=>e.tool.name===t)}),e=null,this.renderShortlist();else{const e=t.dataTransfer.getData("text/plain"),s=this.TREASURY_TOOLS.find(t=>t.name===e);s&&!this.shortlist.some(t=>t.tool.name===e)&&(this.shortlist.push({tool:s,notes:""}),this.renderShortlist())}}),o.addEventListener("dragend",()=>{window.removeEventListener("pointermove",n),s&&(s.remove(),s=null)}),o.addEventListener("touchstart",e=>{const o=e.target.closest(".shortlist-card");if(o){t=o,i(),s=o.cloneNode(!0),s.classList.add("drag-preview"),s.style.width=`${o.offsetWidth}px`,s.style.height=`${o.offsetHeight}px`,portalRoot.appendChild(s);const n=e.touches[0];s.style.left=`${n.clientX}px`,s.style.top=`${n.clientY}px`}},{passive:!0}),o.addEventListener("touchmove",e=>{if(!t)return;const n=e.touches[0];s&&(s.style.left=`${n.clientX}px`,s.style.top=`${n.clientY}px`);const i=document.elementFromPoint(n.clientX,n.clientY)?.closest(".shortlist-card");if(i&&i!==t){const e=i.getBoundingClientRect(),s=n.clientY-e.top>e.height/2;o.insertBefore(t,s?i.nextSibling:i)}e.preventDefault()},{passive:!1}),o.addEventListener("touchend",()=>{t&&(a(),this.shortlist=Array.from(o.querySelectorAll(".shortlist-card")).map(e=>{const t=e.dataset.name;return this.shortlist.find(e=>e.tool.name===t)}),t=null,s&&(s.remove(),s=null),this.renderShortlist())})}document.addEventListener("keydown",e=>{"Escape"===e.key&&this.shortlistMenuOpen&&this.closeShortlistMenu()}),this.renderShortlist(),this.setupPermanentToolPicker()}toggleShortlistMenu(){this.shortlistMenuOpen?this.closeShortlistMenu():this.openShortlistMenu()}openShortlistMenu(e){this.closeSideMenu();const t=document.getElementById("shortlistMenu"),s=document.getElementById("shortlistMenuOverlay"),o=document.getElementById("shortlistMenuToggle"),n=document.getElementById("externalShortlistToggle");t?.classList.add("open"),portalRoot.classList.add("shortlist-menu-open"),s?.classList.add("show"),document.addEventListener("click",this.handleOutsideShortlistMenuClick),o?.classList.add("active"),n?.classList.add("active"),this.isMobile()?(document.body.style.overflow="hidden",document.body.style.position="fixed",document.body.style.width="100%"):portalRoot.style.overflow="hidden",this.shortlistMenuOpen=!0,this.permanentToolPickerInitialized&&this.updatePermanentToolPicker()}closeShortlistMenu(){const e=document.getElementById("shortlistMenu"),t=document.getElementById("shortlistMenuOverlay"),s=document.getElementById("shortlistMenuToggle"),o=document.getElementById("externalShortlistToggle");e?.classList.remove("open"),portalRoot.classList.remove("shortlist-menu-open"),t?.classList.remove("show"),document.removeEventListener("click",this.handleOutsideShortlistMenuClick),s?.classList.remove("active"),o?.classList.remove("active"),this.isMobile()?(document.body.style.overflow="",document.body.style.position="",document.body.style.width=""):portalRoot.style.overflow="",this.shortlistMenuOpen=!1}renderShortlist(){const e=document.getElementById("shortlistContainer"),t=document.getElementById("shortlistEmptyMessage");if(!e)return;e.innerHTML="",t&&e.appendChild(t),0===this.shortlist.length?(e.classList.add("empty"),t&&t.classList.remove("visually-hidden")):(e.classList.remove("empty"),t&&t.classList.add("visually-hidden"),this.shortlist.forEach(t=>{const s=document.createElement("div");s.className="shortlist-card",s.draggable=!0,s.dataset.name=t.tool.name,s.innerHTML=`\n                            <div class="shortlist-card-header">\n                                <div class="shortlist-card-title-wrapper">\n                                    ${t.tool.logoUrl?`<img class="shortlist-logo" src="${t.tool.logoUrl}" alt="${t.tool.name} logo">`:""}\n                                    <span class="shortlist-card-title">${t.tool.name}</span>\n                                    ${t.tool.websiteUrl?`<a class="shortlist-card-link" href="${t.tool.websiteUrl}" target="_blank" rel="noopener noreferrer" aria-label="Visit website">Visit Website</a>`:""}\n                                </div>\n                                <div class="shortlist-card-buttons">\n                                    <button class="move-up" data-name="${t.tool.name}" aria-label="Move up">‚ñ≤</button>\n                                    <button class="move-down" data-name="${t.tool.name}" aria-label="Move down">‚ñº</button>\n                                    <button class="remove-shortlist" data-name="${t.tool.name}" aria-label="Remove">√ó</button>\n                                </div>\n                            </div>\n                            <textarea class="shortlist-note" data-name="${t.tool.name}" placeholder="Notes...">${t.notes||""}</textarea>`,e.appendChild(s)})),e.querySelectorAll(".remove-shortlist").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.dataset.name;this.shortlist=this.shortlist.filter(e=>e.tool.name!==t),this.renderShortlist()})}),e.querySelectorAll(".move-up").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.dataset.name,s=this.shortlist.findIndex(e=>e.tool.name===t);if(s>0){const[e]=this.shortlist.splice(s,1);this.shortlist.splice(s-1,0,e),this.renderShortlist()}})}),e.querySelectorAll(".move-down").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.dataset.name,s=this.shortlist.findIndex(e=>e.tool.name===t);if(s<this.shortlist.length-1&&-1!==s){const[e]=this.shortlist.splice(s,1);this.shortlist.splice(s+1,0,e),this.renderShortlist()}})}),e.querySelectorAll(".shortlist-note").forEach(e=>{e.addEventListener("input",e=>{const t=e.target.dataset.name,s=this.shortlist.find(e=>e.tool.name===t);s&&(s.notes=e.target.value)})});const s=document.getElementById("exportShortlistBtn");s&&(s.disabled=0===this.shortlist.length),this.updatePermanentToolPicker()}updatePermanentToolPicker(){const e=document.getElementById("permanentToolPicker")?.querySelector(".tool-picker-button"),t=document.getElementById("permanentDropdown"),s=document.getElementById("permanentSearch"),o=document.getElementById("permanentList");if(!(e&&t&&s&&o))return;const n=this.TREASURY_TOOLS.filter(e=>!this.shortlist.some(t=>t.tool.name===e.name));o.innerHTML=n.map(e=>`<li data-name="${e.name}">${e.name}</li>`).join(""),e.textContent=n.length>0?`Add a Tool (${n.length} available)`:"All tools added",e.disabled=0===n.length,s.value="",t.style.display="none"}setupPermanentToolPicker(){const e=document.getElementById("permanentToolPicker")?.querySelector(".tool-picker-button"),t=document.getElementById("permanentDropdown"),s=document.getElementById("permanentSearch"),o=document.getElementById("permanentList");e&&t&&s&&o&&(e.addEventListener("click",e=>{e.stopPropagation();const o="block"===t.style.display;t.style.display=o?"none":"block",o||s.focus()}),s.addEventListener("input",()=>{const e=s.value.toLowerCase();o.querySelectorAll("li").forEach(t=>{const s=t.textContent.toLowerCase().includes(e);t.style.display=s?"block":"none"})}),o.addEventListener("click",e=>{if("LI"===e.target.tagName){const s=e.target.dataset.name,o=this.TREASURY_TOOLS.find(e=>e.name===s);o&&!this.shortlist.some(e=>e.tool.name===s)&&(this.shortlist.push({tool:o,notes:""}),this.renderShortlist()),t.style.display="none"}}),document.addEventListener("click",e=>{const s=document.getElementById("permanentToolPicker");s&&!s.contains(e.target)&&(t.style.display="none")}),this.updatePermanentToolPicker(),this.permanentToolPickerInitialized=!0)}clearShortlist(){this.shortlist=[],this.renderShortlist()}setupBottomNav(){const e=document.getElementById("bottomSearch"),t=document.getElementById("bottomShortlist");if(e){const t=e=>{e.preventDefault(),e.stopPropagation(),this.shortlistMenuOpen&&this.closeShortlistMenu(),this.sideMenuOpen?this.closeSideMenu():(this.openSideMenu(),setTimeout(()=>{const e=document.getElementById("searchInput");e&&(e.focus(),/iPad|iPhone|iPod/.test(navigator.userAgent)&&e.click())},350))};e.addEventListener("touchstart",e=>e.preventDefault()),e.addEventListener("click",t),e.addEventListener("touchend",e=>{e.preventDefault(),t(e)})}if(t){const e=e=>{e.preventDefault(),e.stopPropagation(),this.sideMenuOpen&&this.closeSideMenu(),this.toggleShortlistMenu()};t.addEventListener("click",e),t.addEventListener("touchend",t=>{t.preventDefault(),e(t)})}}updateFeatureFilters(){const e=document.querySelectorAll('#tagFilters input[type="checkbox"]');this.advancedFilters.features=Array.from(e).filter(e=>e.checked).map(e=>e.value)}applyViewStyles(){document.querySelectorAll(".tools-grid").forEach(e=>{e.classList.remove("list-view"),"list"===this.currentView?(e.classList.add("list-view"),e.style.gridTemplateColumns="1fr"):this.isMobile()?e.style.gridTemplateColumns="1fr":e.style.gridTemplateColumns="repeat(auto-fill, minmax(320px, 1fr))"})}exportShortlist(){const e=this.shortlist.map(e=>({name:e.tool.name,category:e.tool.category,website:e.tool.websiteUrl||"",notes:e.notes||""})),t=this.convertToCSV(e);this.downloadCSV(t,"shortlist.csv")}convertToCSV(e){if(!e.length)return"";const t=Object.keys(e[0]);return[t.join(","),...e.map(e=>t.map(t=>`"${String(e[t]).replace(/"/g,'""')}"`).join(","))].join("\n")}downloadCSV(e,t){const s=new Blob([e],{type:"text/csv;charset=utf-8;"}),o=document.createElement("a");if(void 0!==o.download){const e=URL.createObjectURL(s);o.setAttribute("href",e),o.setAttribute("download",t),o.style.visibility="hidden",document.body.appendChild(o),o.click(),URL.revokeObjectURL(e),document.body.removeChild(o)}}clearAllFilters(){const e=document.getElementById("searchInput");e&&(e.value="",this.searchTerm="");const t=document.getElementById("tagSearchInput");t&&(t.value="");const s=document.getElementById("tagSearchClear");s&&(s.style.display="none"),this.filterTagCheckboxes(""),document.querySelector(".filter-tab.active")?.classList.remove("active"),this.currentFilter="ALL",this.renderSubcategoryTabs(null),this.advancedFilters={features:[],hasVideo:!1,regions:[],categories:[],subcategories:[]};document.querySelectorAll('#tagFilters input[type="checkbox"],#hasVideoFilter,#regionFilters input[type="checkbox"],#categoryFilters input[type="checkbox"],#subcategoryFilters input[type="checkbox"]').forEach(e=>e.checked=!1);const o=document.getElementById("headerRegionFilter");o&&(o.value="");const n=document.getElementById("headerCategoryFilter");n&&(n.value=""),this.filterAndDisplayTools(),this.updateFilterCount()}resetToDefaults(){this.clearAllFilters();const e=document.getElementById("sortFilter");e&&(e.value="name"),this.currentSort="name",document.querySelectorAll(".view-option").forEach(e=>e.classList.remove("active")),document.querySelector('.view-option[data-view="grid"]')?.classList.add("active"),this.currentView="grid";const t=document.getElementById("groupByFilter");t&&(t.value="category"),this.groupByCategory=!0,this.applyViewStyles(),this.filterAndDisplayTools()}updateFilterCount(){const{features:e,hasVideo:t,regions:s,categories:o,subcategories:n}=this.advancedFilters;let i=0;i+=e.length+s.length+o.length+n.length,t&&i++;const a=document.getElementById("filterCount");a&&(a.textContent=i>0?`(${i})`:"")}}let lastTouchEnd=0;document.addEventListener("touchend",function(e){const t=Date.now();t-lastTouchEnd<=300&&e.preventDefault(),lastTouchEnd=t},{passive:!1});